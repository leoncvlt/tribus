import{D as Qt,H as ce,F as we,a as Te,L as $t,b as ae,S as ye,B as Jt,M as ee,c as es,P as Tt,d as L,e as z,f as ts,E as wt,V as I,g as ne,T as ie,Q as Ce,h as it,i as K,W as ss,C as ns,j as k,k as Be,l as Ee,m as re,n as Ie,O as He,G as ue,o as is,p as rs,q as he,r as de,I as je,s as pe,t as as,u as be,v as rt,R as os,w as Oe,U as ls,x as Mt,y as ve,z as Me,A as bt,J as vt,K as cs,N as at,X as De,Y as us,Z as J,_ as Ke,$ as hs,a0 as Z,a1 as te,a2 as ds,a3 as yt,a4 as fs,a5 as ps,a6 as Et,a7 as Ne,a8 as ms,a9 as Ae,aa as gs,ab as xs,ac as Ts,ad as ws,ae as Ms,af as bs,ag as vs,ah as St,ai as ys,aj as Es,ak as Ss,al as Rs,am as Rt,an as _s,ao as As,ap as Ls,aq as Ps,ar as Cs,as as Is,at as Os,au as Ds,av as Ns,aw as ot,ax as Fs,ay as Us,az as lt,aA as ks,aB as Gs,aC as Bs,aD as Hs}from"./three.366ea245.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))t(n);new MutationObserver(n=>{for(const i of n)if(i.type==="childList")for(const r of i.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&t(r)}).observe(document,{childList:!0,subtree:!0});function s(n){const i={};return n.integrity&&(i.integrity=n.integrity),n.referrerpolicy&&(i.referrerPolicy=n.referrerpolicy),n.crossorigin==="use-credentials"?i.credentials="include":n.crossorigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function t(n){if(n.ep)return;n.ep=!0;const i=s(n);fetch(n.href,i)}})();class _t extends Qt{constructor(e){super(e),this.type=ce}parse(e){const a=function(m,v){switch(m){case 1:console.error("THREE.RGBELoader Read Error: "+(v||""));break;case 2:console.error("THREE.RGBELoader Write Error: "+(v||""));break;case 3:console.error("THREE.RGBELoader Bad File Format: "+(v||""));break;default:case 4:console.error("THREE.RGBELoader: Error: "+(v||""))}return-1},u=`
`,f=function(m,v,g){v=v||1024;let _=m.pos,R=-1,M=0,C="",y=String.fromCharCode.apply(null,new Uint16Array(m.subarray(_,_+128)));for(;0>(R=y.indexOf(u))&&M<v&&_<m.byteLength;)C+=y,M+=y.length,_+=128,y+=String.fromCharCode.apply(null,new Uint16Array(m.subarray(_,_+128)));return-1<R?(g!==!1&&(m.pos+=M+R+1),C+y.slice(0,R)):!1},p=function(m){const v=/^#\?(\S+)/,g=/^\s*GAMMA\s*=\s*(\d+(\.\d+)?)\s*$/,S=/^\s*EXPOSURE\s*=\s*(\d+(\.\d+)?)\s*$/,_=/^\s*FORMAT=(\S+)\s*$/,R=/^\s*\-Y\s+(\d+)\s+\+X\s+(\d+)\s*$/,M={valid:0,string:"",comments:"",programtype:"RGBE",format:"",gamma:1,exposure:1,width:0,height:0};let C,y;if(m.pos>=m.byteLength||!(C=f(m)))return a(1,"no header found");if(!(y=C.match(v)))return a(3,"bad initial token");for(M.valid|=1,M.programtype=y[1],M.string+=C+`
`;C=f(m),C!==!1;){if(M.string+=C+`
`,C.charAt(0)==="#"){M.comments+=C+`
`;continue}if((y=C.match(g))&&(M.gamma=parseFloat(y[1])),(y=C.match(S))&&(M.exposure=parseFloat(y[1])),(y=C.match(_))&&(M.valid|=2,M.format=y[1]),(y=C.match(R))&&(M.valid|=4,M.height=parseInt(y[1],10),M.width=parseInt(y[2],10)),M.valid&2&&M.valid&4)break}return M.valid&2?M.valid&4?M:a(3,"missing image size specifier"):a(3,"missing format specifier")},w=function(m,v,g){const S=v;if(S<8||S>32767||m[0]!==2||m[1]!==2||m[2]&128)return new Uint8Array(m);if(S!==(m[2]<<8|m[3]))return a(3,"wrong scanline width");const _=new Uint8Array(4*v*g);if(!_.length)return a(4,"unable to allocate buffer space");let R=0,M=0;const C=4*S,y=new Uint8Array(4),U=new Uint8Array(C);let D=g;for(;D>0&&M<m.byteLength;){if(M+4>m.byteLength)return a(1);if(y[0]=m[M++],y[1]=m[M++],y[2]=m[M++],y[3]=m[M++],y[0]!=2||y[1]!=2||(y[2]<<8|y[3])!=S)return a(3,"bad rgbe scanline format");let B=0,O;for(;B<C&&M<m.byteLength;){O=m[M++];const j=O>128;if(j&&(O-=128),O===0||B+O>C)return a(3,"bad scanline data");if(j){const H=m[M++];for(let ge=0;ge<O;ge++)U[B++]=H}else U.set(m.subarray(M,M+O),B),B+=O,M+=O}const Q=S;for(let j=0;j<Q;j++){let H=0;_[R]=U[j+H],H+=S,_[R+1]=U[j+H],H+=S,_[R+2]=U[j+H],H+=S,_[R+3]=U[j+H],R+=4}D--}return _},E=function(m,v,g,S){const _=m[v+3],R=Math.pow(2,_-128)/255;g[S+0]=m[v+0]*R,g[S+1]=m[v+1]*R,g[S+2]=m[v+2]*R,g[S+3]=1},x=function(m,v,g,S){const _=m[v+3],R=Math.pow(2,_-128)/255;g[S+0]=Te.toHalfFloat(Math.min(m[v+0]*R,65504)),g[S+1]=Te.toHalfFloat(Math.min(m[v+1]*R,65504)),g[S+2]=Te.toHalfFloat(Math.min(m[v+2]*R,65504)),g[S+3]=Te.toHalfFloat(1)},T=new Uint8Array(e);T.pos=0;const P=p(T);if(P!==-1){const m=P.width,v=P.height,g=w(T.subarray(T.pos),m,v);if(g!==-1){let S,_,R;switch(this.type){case we:R=g.length/4;const M=new Float32Array(R*4);for(let y=0;y<R;y++)E(g,y*4,M,y*4);S=M,_=we;break;case ce:R=g.length/4;const C=new Uint16Array(R*4);for(let y=0;y<R;y++)x(g,y*4,C,y*4);S=C,_=ce;break;default:console.error("THREE.RGBELoader: unsupported type: ",this.type);break}return{width:m,height:v,data:S,header:P.string,gamma:P.gamma,exposure:P.exposure,type:_}}}return null}setDataType(e){return this.type=e,this}load(e,s,t,n){function i(r,a){switch(r.type){case we:case ce:r.encoding=$t,r.minFilter=ae,r.magFilter=ae,r.generateMipmaps=!1,r.flipY=!0;break}s&&s(r,a)}return super.load(e,i,t,n)}}class At{constructor(e,s,{texture:t,equirectangular:n,cubemap:i,background:r}={}){this.pmremGenerator=new ts(e),this.renderer=e,this.scene=s,this.apply({texture:t,equirectangular:n,cubemap:i,background:r})}async apply({texture:e=null,equirectangular:s=!1,cubemap:t=!1,background:n=!1}={}){e||(e=this.pmremGenerator.fromScene(new js).texture),(typeof e=="string"||e instanceof String)&&(e=await new RGBELoader().loadAsync(e),this.renderer.initTexture(e)),s&&(e=this.pmremGenerator.fromEquirectangular(e).texture),t&&(e=this.pmremGenerator.fromCubemap(e).texture),this.scene.environment=e,n&&(this.scene.background=e)}}class js extends ye{constructor(){super();const e=new Jt;e.deleteAttribute("uv");const s=new ee({side:es}),t=new ee,n=new Tt(16777215,5,28,2);n.position.set(.418,16.199,.3),this.add(n);const i=new L(e,s);i.position.set(-.757,13.219,.717),i.scale.set(31.713,28.305,28.591),this.add(i);const r=new L(e,t);r.position.set(-10.906,2.009,1.846),r.rotation.set(0,-.195,0),r.scale.set(2.328,7.905,4.651),this.add(r);const a=new L(e,t);a.position.set(-5.607,-.754,-.758),a.rotation.set(0,.994,0),a.scale.set(1.97,1.534,3.955),this.add(a);const o=new L(e,t);o.position.set(6.167,.857,7.803),o.rotation.set(0,.561,0),o.scale.set(3.927,6.285,3.687),this.add(o);const l=new L(e,t);l.position.set(-2.017,.018,6.124),l.rotation.set(0,.333,0),l.scale.set(2.002,4.566,2.064),this.add(l);const h=new L(e,t);h.position.set(2.291,-.756,-2.621),h.rotation.set(0,-.286,0),h.scale.set(1.546,1.552,1.496),this.add(h);const u=new L(e,t);u.position.set(-2.193,-.369,-5.547),u.rotation.set(0,.516,0),u.scale.set(3.875,3.487,2.986),this.add(u);const f=new L(e,this.createAreaLightMaterial(50));f.position.set(-16.116,14.37,8.208),f.scale.set(.1,2.428,2.739),this.add(f);const p=new L(e,this.createAreaLightMaterial(50));p.position.set(-16.109,18.021,-8.207),p.scale.set(.1,2.425,2.751),this.add(p);const w=new L(e,this.createAreaLightMaterial(17));w.position.set(14.904,12.198,-1.832),w.scale.set(.15,4.265,6.331),this.add(w);const E=new L(e,this.createAreaLightMaterial(43));E.position.set(-.462,8.89,14.52),E.scale.set(4.38,5.441,.088),this.add(E);const x=new L(e,this.createAreaLightMaterial(20));x.position.set(3.235,11.486,-12.541),x.scale.set(2.5,2,.1),this.add(x);const T=new L(e,this.createAreaLightMaterial(100));T.position.set(0,20,0),T.scale.set(1,.1,1),this.add(T)}createAreaLightMaterial(e){const s=new z;return s.color.setScalar(e),s}}const ct={type:"change"},Le={type:"start"},ut={type:"end"};class Ks extends wt{constructor(e,s){super(),this.object=e,this.domElement=s,this.domElement.style.touchAction="none",this.enabled=!0,this.target=new I,this.minDistance=0,this.maxDistance=1/0,this.minZoom=0,this.maxZoom=1/0,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.enableDamping=!1,this.dampingFactor=.05,this.enableZoom=!0,this.zoomSpeed=1,this.enableRotate=!0,this.rotateSpeed=1,this.enablePan=!0,this.panSpeed=1,this.screenSpacePanning=!0,this.keyPanSpeed=7,this.autoRotate=!1,this.autoRotateSpeed=2,this.keys={LEFT:"ArrowLeft",UP:"ArrowUp",RIGHT:"ArrowRight",BOTTOM:"ArrowDown"},this.mouseButtons={LEFT:ne.ROTATE,MIDDLE:ne.DOLLY,RIGHT:ne.PAN},this.touches={ONE:ie.ROTATE,TWO:ie.DOLLY_PAN},this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.zoom0=this.object.zoom,this._domElementKeyEvents=null,this.getPolarAngle=function(){return a.phi},this.getAzimuthalAngle=function(){return a.theta},this.getDistance=function(){return this.object.position.distanceTo(this.target)},this.listenToKeyEvents=function(c){c.addEventListener("keydown",Je),this._domElementKeyEvents=c},this.saveState=function(){t.target0.copy(t.target),t.position0.copy(t.object.position),t.zoom0=t.object.zoom},this.reset=function(){t.target.copy(t.target0),t.object.position.copy(t.position0),t.object.zoom=t.zoom0,t.object.updateProjectionMatrix(),t.dispatchEvent(ct),t.update(),i=n.NONE},this.update=function(){const c=new I,b=new Ce().setFromUnitVectors(e.up,new I(0,1,0)),N=b.clone().invert(),F=new I,V=new Ce,se=2*Math.PI;return function(){const nt=t.object.position;c.copy(nt).sub(t.target),c.applyQuaternion(b),a.setFromVector3(c),t.autoRotate&&i===n.NONE&&M(_()),t.enableDamping?(a.theta+=o.theta*t.dampingFactor,a.phi+=o.phi*t.dampingFactor):(a.theta+=o.theta,a.phi+=o.phi);let W=t.minAzimuthAngle,Y=t.maxAzimuthAngle;return isFinite(W)&&isFinite(Y)&&(W<-Math.PI?W+=se:W>Math.PI&&(W-=se),Y<-Math.PI?Y+=se:Y>Math.PI&&(Y-=se),W<=Y?a.theta=Math.max(W,Math.min(Y,a.theta)):a.theta=a.theta>(W+Y)/2?Math.max(W,a.theta):Math.min(Y,a.theta)),a.phi=Math.max(t.minPolarAngle,Math.min(t.maxPolarAngle,a.phi)),a.makeSafe(),a.radius*=l,a.radius=Math.max(t.minDistance,Math.min(t.maxDistance,a.radius)),t.enableDamping===!0?t.target.addScaledVector(h,t.dampingFactor):t.target.add(h),c.setFromSpherical(a),c.applyQuaternion(N),nt.copy(t.target).add(c),t.object.lookAt(t.target),t.enableDamping===!0?(o.theta*=1-t.dampingFactor,o.phi*=1-t.dampingFactor,h.multiplyScalar(1-t.dampingFactor)):(o.set(0,0,0),h.set(0,0,0)),l=1,u||F.distanceToSquared(t.object.position)>r||8*(1-V.dot(t.object.quaternion))>r?(t.dispatchEvent(ct),F.copy(t.object.position),V.copy(t.object.quaternion),u=!1,!0):!1}}(),this.dispose=function(){t.domElement.removeEventListener("contextmenu",et),t.domElement.removeEventListener("pointerdown",Ze),t.domElement.removeEventListener("pointercancel",Qe),t.domElement.removeEventListener("wheel",$e),t.domElement.removeEventListener("pointermove",Se),t.domElement.removeEventListener("pointerup",Re),t._domElementKeyEvents!==null&&t._domElementKeyEvents.removeEventListener("keydown",Je)};const t=this,n={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_PAN:4,TOUCH_DOLLY_PAN:5,TOUCH_DOLLY_ROTATE:6};let i=n.NONE;const r=1e-6,a=new it,o=new it;let l=1;const h=new I;let u=!1;const f=new K,p=new K,w=new K,E=new K,x=new K,T=new K,P=new K,m=new K,v=new K,g=[],S={};function _(){return 2*Math.PI/60/60*t.autoRotateSpeed}function R(){return Math.pow(.95,t.zoomSpeed)}function M(c){o.theta-=c}function C(c){o.phi-=c}const y=function(){const c=new I;return function(N,F){c.setFromMatrixColumn(F,0),c.multiplyScalar(-N),h.add(c)}}(),U=function(){const c=new I;return function(N,F){t.screenSpacePanning===!0?c.setFromMatrixColumn(F,1):(c.setFromMatrixColumn(F,0),c.crossVectors(t.object.up,c)),c.multiplyScalar(N),h.add(c)}}(),D=function(){const c=new I;return function(N,F){const V=t.domElement;if(t.object.isPerspectiveCamera){const se=t.object.position;c.copy(se).sub(t.target);let xe=c.length();xe*=Math.tan(t.object.fov/2*Math.PI/180),y(2*N*xe/V.clientHeight,t.object.matrix),U(2*F*xe/V.clientHeight,t.object.matrix)}else t.object.isOrthographicCamera?(y(N*(t.object.right-t.object.left)/t.object.zoom/V.clientWidth,t.object.matrix),U(F*(t.object.top-t.object.bottom)/t.object.zoom/V.clientHeight,t.object.matrix)):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled."),t.enablePan=!1)}}();function B(c){t.object.isPerspectiveCamera?l/=c:t.object.isOrthographicCamera?(t.object.zoom=Math.max(t.minZoom,Math.min(t.maxZoom,t.object.zoom*c)),t.object.updateProjectionMatrix(),u=!0):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),t.enableZoom=!1)}function O(c){t.object.isPerspectiveCamera?l*=c:t.object.isOrthographicCamera?(t.object.zoom=Math.max(t.minZoom,Math.min(t.maxZoom,t.object.zoom/c)),t.object.updateProjectionMatrix(),u=!0):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),t.enableZoom=!1)}function Q(c){f.set(c.clientX,c.clientY)}function j(c){P.set(c.clientX,c.clientY)}function H(c){E.set(c.clientX,c.clientY)}function ge(c){p.set(c.clientX,c.clientY),w.subVectors(p,f).multiplyScalar(t.rotateSpeed);const b=t.domElement;M(2*Math.PI*w.x/b.clientHeight),C(2*Math.PI*w.y/b.clientHeight),f.copy(p),t.update()}function kt(c){m.set(c.clientX,c.clientY),v.subVectors(m,P),v.y>0?B(R()):v.y<0&&O(R()),P.copy(m),t.update()}function Gt(c){x.set(c.clientX,c.clientY),T.subVectors(x,E).multiplyScalar(t.panSpeed),D(T.x,T.y),E.copy(x),t.update()}function Bt(c){c.deltaY<0?O(R()):c.deltaY>0&&B(R()),t.update()}function Ht(c){let b=!1;switch(c.code){case t.keys.UP:D(0,t.keyPanSpeed),b=!0;break;case t.keys.BOTTOM:D(0,-t.keyPanSpeed),b=!0;break;case t.keys.LEFT:D(t.keyPanSpeed,0),b=!0;break;case t.keys.RIGHT:D(-t.keyPanSpeed,0),b=!0;break}b&&(c.preventDefault(),t.update())}function Ve(){if(g.length===1)f.set(g[0].pageX,g[0].pageY);else{const c=.5*(g[0].pageX+g[1].pageX),b=.5*(g[0].pageY+g[1].pageY);f.set(c,b)}}function ze(){if(g.length===1)E.set(g[0].pageX,g[0].pageY);else{const c=.5*(g[0].pageX+g[1].pageX),b=.5*(g[0].pageY+g[1].pageY);E.set(c,b)}}function We(){const c=g[0].pageX-g[1].pageX,b=g[0].pageY-g[1].pageY,N=Math.sqrt(c*c+b*b);P.set(0,N)}function jt(){t.enableZoom&&We(),t.enablePan&&ze()}function Kt(){t.enableZoom&&We(),t.enableRotate&&Ve()}function Ye(c){if(g.length==1)p.set(c.pageX,c.pageY);else{const N=_e(c),F=.5*(c.pageX+N.x),V=.5*(c.pageY+N.y);p.set(F,V)}w.subVectors(p,f).multiplyScalar(t.rotateSpeed);const b=t.domElement;M(2*Math.PI*w.x/b.clientHeight),C(2*Math.PI*w.y/b.clientHeight),f.copy(p)}function Xe(c){if(g.length===1)x.set(c.pageX,c.pageY);else{const b=_e(c),N=.5*(c.pageX+b.x),F=.5*(c.pageY+b.y);x.set(N,F)}T.subVectors(x,E).multiplyScalar(t.panSpeed),D(T.x,T.y),E.copy(x)}function qe(c){const b=_e(c),N=c.pageX-b.x,F=c.pageY-b.y,V=Math.sqrt(N*N+F*F);m.set(0,V),v.set(0,Math.pow(m.y/P.y,t.zoomSpeed)),B(v.y),P.copy(m)}function Vt(c){t.enableZoom&&qe(c),t.enablePan&&Xe(c)}function zt(c){t.enableZoom&&qe(c),t.enableRotate&&Ye(c)}function Ze(c){t.enabled!==!1&&(g.length===0&&(t.domElement.setPointerCapture(c.pointerId),t.domElement.addEventListener("pointermove",Se),t.domElement.addEventListener("pointerup",Re)),Zt(c),c.pointerType==="touch"?Xt(c):Wt(c))}function Se(c){t.enabled!==!1&&(c.pointerType==="touch"?qt(c):Yt(c))}function Re(c){tt(c),g.length===0&&(t.domElement.releasePointerCapture(c.pointerId),t.domElement.removeEventListener("pointermove",Se),t.domElement.removeEventListener("pointerup",Re)),t.dispatchEvent(ut),i=n.NONE}function Qe(c){tt(c)}function Wt(c){let b;switch(c.button){case 0:b=t.mouseButtons.LEFT;break;case 1:b=t.mouseButtons.MIDDLE;break;case 2:b=t.mouseButtons.RIGHT;break;default:b=-1}switch(b){case ne.DOLLY:if(t.enableZoom===!1)return;j(c),i=n.DOLLY;break;case ne.ROTATE:if(c.ctrlKey||c.metaKey||c.shiftKey){if(t.enablePan===!1)return;H(c),i=n.PAN}else{if(t.enableRotate===!1)return;Q(c),i=n.ROTATE}break;case ne.PAN:if(c.ctrlKey||c.metaKey||c.shiftKey){if(t.enableRotate===!1)return;Q(c),i=n.ROTATE}else{if(t.enablePan===!1)return;H(c),i=n.PAN}break;default:i=n.NONE}i!==n.NONE&&t.dispatchEvent(Le)}function Yt(c){switch(i){case n.ROTATE:if(t.enableRotate===!1)return;ge(c);break;case n.DOLLY:if(t.enableZoom===!1)return;kt(c);break;case n.PAN:if(t.enablePan===!1)return;Gt(c);break}}function $e(c){t.enabled===!1||t.enableZoom===!1||i!==n.NONE||(c.preventDefault(),t.dispatchEvent(Le),Bt(c),t.dispatchEvent(ut))}function Je(c){t.enabled===!1||t.enablePan===!1||Ht(c)}function Xt(c){switch(st(c),g.length){case 1:switch(t.touches.ONE){case ie.ROTATE:if(t.enableRotate===!1)return;Ve(),i=n.TOUCH_ROTATE;break;case ie.PAN:if(t.enablePan===!1)return;ze(),i=n.TOUCH_PAN;break;default:i=n.NONE}break;case 2:switch(t.touches.TWO){case ie.DOLLY_PAN:if(t.enableZoom===!1&&t.enablePan===!1)return;jt(),i=n.TOUCH_DOLLY_PAN;break;case ie.DOLLY_ROTATE:if(t.enableZoom===!1&&t.enableRotate===!1)return;Kt(),i=n.TOUCH_DOLLY_ROTATE;break;default:i=n.NONE}break;default:i=n.NONE}i!==n.NONE&&t.dispatchEvent(Le)}function qt(c){switch(st(c),i){case n.TOUCH_ROTATE:if(t.enableRotate===!1)return;Ye(c),t.update();break;case n.TOUCH_PAN:if(t.enablePan===!1)return;Xe(c),t.update();break;case n.TOUCH_DOLLY_PAN:if(t.enableZoom===!1&&t.enablePan===!1)return;Vt(c),t.update();break;case n.TOUCH_DOLLY_ROTATE:if(t.enableZoom===!1&&t.enableRotate===!1)return;zt(c),t.update();break;default:i=n.NONE}}function et(c){t.enabled!==!1&&c.preventDefault()}function Zt(c){g.push(c)}function tt(c){delete S[c.pointerId];for(let b=0;b<g.length;b++)if(g[b].pointerId==c.pointerId){g.splice(b,1);return}}function st(c){let b=S[c.pointerId];b===void 0&&(b=new K,S[c.pointerId]=b),b.set(c.pageX,c.pageY)}function _e(c){const b=c.pointerId===g[0].pointerId?g[1]:g[0];return S[b.pointerId]}t.domElement.addEventListener("contextmenu",et),t.domElement.addEventListener("pointerdown",Ze),t.domElement.addEventListener("pointercancel",Qe),t.domElement.addEventListener("wheel",$e,{passive:!1}),this.update()}}class Vs{constructor(){}begin(){}end(){}}class me{get parameters(){return{}}constructor({gui:e}){this.renderer=new ss({canvas:document.querySelector("canvas"),antialias:!0}),this.clock=new ns,this.scene=new ye,this.scene.background=new k(16777215),this.camera=new Be,this.controls=new Ks(this.camera,this.renderer.domElement),this.controls.enableDamping=!0,this.stats=new Vs,this._start(),this.gui=e}async _start(){await this.start(),this._params={};const e=Object.entries(this.parameters);e.length?e.forEach(([s,{value:t,onChange:n,...i}])=>{this._params[s]=t,this.gui.addInput(this._params,s,i).on("change",({value:a})=>n(a))}):this.gui.dispose(),this.controls&&this.renderer.domElement.classList.add("controls"),this._update()}_update(){const e=this.renderer.domElement,s=e.clientWidth,t=e.clientHeight;(e.width!==s||e.height!==t)&&(this.renderer.setSize(s,t,!1),this.camera.aspect=e.clientWidth/e.clientHeight,this.camera.updateProjectionMatrix());const i=this.clock.getDelta(),r=this.clock.getElapsedTime();this.stats.begin(),this.update&&this.update(i,r),this.controls.update(),this.renderer.render(this.scene,this.camera),this.stats.end(),requestAnimationFrame(this._update.bind(this))}}const Lt=""+new URL("venice_sunset_1k.0e72ed46.hdr",import.meta.url).href;class zs extends me{async start(){this.camera.position.z=10,this.torus=new L(new Ee(1.25,.5,128,16),new ee({roughness:.4,metalness:.6})),this.scene.add(this.torus),this.scene.background=this.defaultBackground=new k(.8,.8,.8),this.texture=await new _t().loadAsync(Lt),this.environment=new At(this.renderer,this.scene)}update(e,s){this.torus.rotation.set(s/2,s/2,s/2)}get parameters(){return{texture:{label:"Use texture",value:this.scene.environment===this.texture,onChange:e=>{this.environment.apply({texture:e?this.texture:null,equirectangular:e,background:!(this.scene.background instanceof k)})}},background:{label:"Set background",value:!(this.scene.background instanceof k),onChange:e=>this.scene.background=e?this.scene.environment:this.defaultBackground}}}}const Pt={uniforms:{tDiffuse:{value:null},h:{value:1/512}},vertexShader:`

		varying vec2 vUv;

		void main() {

			vUv = uv;
			gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );

		}`,fragmentShader:`

		uniform sampler2D tDiffuse;
		uniform float h;

		varying vec2 vUv;

		void main() {

			vec4 sum = vec4( 0.0 );

			sum += texture2D( tDiffuse, vec2( vUv.x - 4.0 * h, vUv.y ) ) * 0.051;
			sum += texture2D( tDiffuse, vec2( vUv.x - 3.0 * h, vUv.y ) ) * 0.0918;
			sum += texture2D( tDiffuse, vec2( vUv.x - 2.0 * h, vUv.y ) ) * 0.12245;
			sum += texture2D( tDiffuse, vec2( vUv.x - 1.0 * h, vUv.y ) ) * 0.1531;
			sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y ) ) * 0.1633;
			sum += texture2D( tDiffuse, vec2( vUv.x + 1.0 * h, vUv.y ) ) * 0.1531;
			sum += texture2D( tDiffuse, vec2( vUv.x + 2.0 * h, vUv.y ) ) * 0.12245;
			sum += texture2D( tDiffuse, vec2( vUv.x + 3.0 * h, vUv.y ) ) * 0.0918;
			sum += texture2D( tDiffuse, vec2( vUv.x + 4.0 * h, vUv.y ) ) * 0.051;

			gl_FragColor = sum;

		}`},Ct={uniforms:{tDiffuse:{value:null},v:{value:1/512}},vertexShader:`

		varying vec2 vUv;

		void main() {

			vUv = uv;
			gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );

		}`,fragmentShader:`

		uniform sampler2D tDiffuse;
		uniform float v;

		varying vec2 vUv;

		void main() {

			vec4 sum = vec4( 0.0 );

			sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y - 4.0 * v ) ) * 0.051;
			sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y - 3.0 * v ) ) * 0.0918;
			sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y - 2.0 * v ) ) * 0.12245;
			sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y - 1.0 * v ) ) * 0.1531;
			sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y ) ) * 0.1633;
			sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y + 1.0 * v ) ) * 0.1531;
			sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y + 2.0 * v ) ) * 0.12245;
			sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y + 3.0 * v ) ) * 0.0918;
			sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y + 4.0 * v ) ) * 0.051;

			gl_FragColor = sum;

		}`};class Ws extends L{set opacity(e){this.planeMaterial.opacity=e}get opacity(){return this.planeMaterial.opacity}set darkness(e){this._depthShader.uniforms.darkness.value=e}get darkness(){var e;return((e=this._depthShader)==null?void 0:e.uniforms.darkness.value)||1}constructor({width:e=16,height:s=16,textureWidth:t=512,textureHeight:n=512,cameraHeight:i=16,darkness:r=1,opacity:a=1,blur:o=4,fastBlur:l=!1,manualRender:h=!1}={}){super(),this.textureWidth=t,this.textureHeight=n,this.blur=o,this.fastBlur=l,this.manualRender=h,this.renderTarget=new re(t,n),this.renderTarget.texture.generateMipmaps=!1,this.renderTargetBlur=new re(t,n),this.renderTargetBlur.texture.generateMipmaps=!1;const u=new Ie(e,s).rotateX(Math.PI/2);this.planeMaterial=new z({map:this.renderTarget.texture,opacity:a,transparent:!0,depthWrite:!1});const f=new L(u,this.planeMaterial);f.renderOrder=1,f.scale.y=-1,this.add(f),this.blurPlane=new L(u),this.blurPlane.visible=!1,this.add(this.blurPlane),this.shadowCamera=new He(-e/2,e/2,s/2,-s/2,0,i),this.shadowCamera.rotation.x=Math.PI/2,this.add(this.shadowCamera),this.helpers=new ue;const p=new is(this.shadowCamera);this.helpers.add(p),this.depthMaterial=new rs,this.depthMaterial.onBeforeCompile=w=>{w.uniforms.darkness={value:r},w.fragmentShader=`
						uniform float darkness;
						${w.fragmentShader.replace("gl_FragColor = vec4( vec3( 1.0 - fragCoordZ ), opacity );","gl_FragColor = vec4( vec3( 0.0 ), ( 1.0 - fragCoordZ ) * darkness );")}
					`,this._depthShader=w},this.depthMaterial.depthTest=!1,this.depthMaterial.depthWrite=!1,this.horizontalBlurMaterial=new he(Pt),this.horizontalBlurMaterial.depthTest=!1,this.verticalBlurMaterial=new he(Ct),this.verticalBlurMaterial.depthTest=!1}blurShadow(e,s){this.blurPlane.visible=!0,this.blurPlane.material=this.horizontalBlurMaterial,this.blurPlane.material.uniforms.tDiffuse.value=this.renderTarget.texture,this.horizontalBlurMaterial.uniforms.h.value=s*1/this.textureWidth,e.setRenderTarget(this.renderTargetBlur),e.render(this.blurPlane,this.shadowCamera),this.blurPlane.material=this.verticalBlurMaterial,this.blurPlane.material.uniforms.tDiffuse.value=this.renderTargetBlur.texture,this.verticalBlurMaterial.uniforms.v.value=s*1/this.textureHeight,e.setRenderTarget(this.renderTarget),e.render(this.blurPlane,this.shadowCamera),this.blurPlane.visible=!1}onBeforeRender(e,s,t){this.manualRender||this.render(e,s)}render(e,s){const t=s.background;s.background=null,this.helpers.visible=!1,s.overrideMaterial=this.depthMaterial;const n=e.getClearAlpha();e.setClearAlpha(0),e.setRenderTarget(this.renderTarget),e.render(s,this.shadowCamera),s.overrideMaterial=null,this.helpers.visible=!0,this.blurShadow(e,this.blur),this.fastBlur||this.blurShadow(e,this.blur*.4),e.setRenderTarget(null),e.setClearAlpha(n),s.background=t}}class Ys extends me{start(){this.camera.position.set(10,10,10),this.controls.target.set(0,2,0),this.torus=new L(new Ee,new de),this.torus.position.set(2,4,-2),this.scene.add(this.torus),this.icos=new L(new je(2),new de),this.icos.position.set(-2,4,2),this.scene.add(this.icos);const e=new L(new pe(32,32),new z);e.rotation.x=-Math.PI/2,this.scene.add(e),this.contactShadows=new Ws({}),this.contactShadows.position.y=.01,this.scene.add(this.contactShadows.helpers),this.scene.add(this.contactShadows)}update(e,s){this.icos.rotation.set(s/2,s/2,s/2),this.icos.position.y=Math.sin(s)+4,this.torus.rotation.set(s/2,s/2,s/2),this.torus.position.y=Math.sin(Math.PI+s)+4}get parameters(){return{darkness:{label:"Darkness",value:this.contactShadows.darkness,min:.5,max:1.5,onChange:e=>this.contactShadows.darkness=e},opacity:{label:"Opacity",value:this.contactShadows.opacity,min:0,max:1,onChange:e=>this.contactShadows.opacity=e},blur:{label:"Blur",value:this.contactShadows.blur,min:0,max:16,onChange:e=>this.contactShadows.blur=e},fastBlur:{label:"Use fast blur",value:this.contactShadows.fastBlur,onChange:e=>this.contactShadows.fastBlur=e},helpers:{label:"Show helpers",value:this.contactShadows.helpers.parent===this.scene,onChange:e=>{e?this.scene.add(this.contactShadows.helpers):this.scene.remove(this.contactShadows.helpers)}}}}}const Xs={uniforms:{color:{value:null},map:{value:null},opacity:{value:1},textureMatrix:{value:null}},vertexShader:`
    uniform mat4 textureMatrix;
    varying vec4 vUv;
    void main() {
      vUv = textureMatrix * vec4( position, 1.0 );
      gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
    }
  `,fragmentShader:`
    uniform vec3 color;
    uniform sampler2D map;
    uniform float opacity;
    varying vec4 vUv;
    void main() {
      vec4 base = texture2DProj( map, vUv );
      gl_FragColor = vec4(base.rgb * color, base.a * opacity );
      gl_FragColor.rgb *= opacity;
    }
  `};class It extends L{set opacity(e){this.material.uniforms.opacity.value=e}get opacity(){return this.material.uniforms.opacity.value}constructor({geometry:e,width:s=32,height:t=32,textureWidth:n=512,textureHeight:i=512,color:r=16777215,clipBias:a=0,opacity:o=1,blur:l=0,fastBlur:h=!1,manualRender:u=!1,excluded:f=[]}={}){e?super(e):(super(new pe(s,t)),this.rotation.x=-Math.PI/2),this.type="Reflector",this.textureWidth=n,this.textureHeight=i,this.excluded=f,this.blur=l,this.fastBlur=h,this.clipBias=a,this.manualRender=u,this.reflectorPlane=new as,this.normal=new I,this.reflectorWorldPosition=new I,this.cameraWorldPosition=new I,this.rotationMatrix=new be,this.lookAtPosition=new I(0,0,-1),this.clipPlane=new rt,this.view=new I,this.target=new I,this.q=new rt,this.textureMatrix=new be,this.virtualCamera=new Be,this.renderTarget=new re(n,i,{minFilter:ae,magFilter:ae,format:os}),(!Oe.isPowerOfTwo(n)||!Oe.isPowerOfTwo(i))&&(this.renderTarget.texture.generateMipmaps=!1),this.renderTargetBlur=this.renderTarget.clone(),this.renderTargetBlur.texture.generateMipmaps=!1;const p=Xs,w=new he({uniforms:ls.clone(p.uniforms),fragmentShader:p.fragmentShader,vertexShader:p.vertexShader});this.material=w,this.material.uniforms.textureMatrix.value=this.textureMatrix,this.material.uniforms.map.value=this.renderTarget.texture,this.material.uniforms.color.value=new k(r),this.material.uniforms.opacity.value=o,this.material.transparent=!0,this.material.depthWrite=!1,this.material.premultipliedAlpha=!0,this.horizontalBlurMaterial=new he(Pt),this.verticalBlurMaterial=new he(Ct),this.screenScene=new ye,this.screenCamera=new He(-1,1,1,-1,0,1),this.screenGeometry=new Mt;const E=new Float32Array([-1,-1,3,-1,-1,3]),x=new Float32Array([0,0,2,0,0,2]);this.screenGeometry.setAttribute("position",new ve(E,2)),this.screenGeometry.setAttribute("uv",new ve(x,2)),this.screen=new L(this.screenGeometry),this.screen.frustumCulled=!1,this.screenScene.add(this.screen)}onBeforeRender(e,s,t){this.manualRender||this.render(e,s,t)}render(e,s,t){if(this.reflectorWorldPosition.setFromMatrixPosition(this.matrixWorld),this.cameraWorldPosition.setFromMatrixPosition(t.matrixWorld),this.rotationMatrix.extractRotation(this.matrixWorld),this.normal.set(0,0,1),this.normal.applyMatrix4(this.rotationMatrix),this.view.subVectors(this.reflectorWorldPosition,this.cameraWorldPosition),this.view.dot(this.normal)>0)return;this.view.reflect(this.normal).negate(),this.view.add(this.reflectorWorldPosition),this.rotationMatrix.extractRotation(t.matrixWorld),this.lookAtPosition.set(0,0,-1),this.lookAtPosition.applyMatrix4(this.rotationMatrix),this.lookAtPosition.add(this.cameraWorldPosition),this.target.subVectors(this.reflectorWorldPosition,this.lookAtPosition),this.target.reflect(this.normal).negate(),this.target.add(this.reflectorWorldPosition),this.virtualCamera.position.copy(this.view),this.virtualCamera.up.set(0,1,0),this.virtualCamera.up.applyMatrix4(this.rotationMatrix),this.virtualCamera.up.reflect(this.normal),this.virtualCamera.lookAt(this.target),this.virtualCamera.far=t.far,this.virtualCamera.updateMatrixWorld(),this.virtualCamera.projectionMatrix.copy(t.projectionMatrix),this.textureMatrix.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),this.textureMatrix.multiply(this.virtualCamera.projectionMatrix),this.textureMatrix.multiply(this.virtualCamera.matrixWorldInverse),this.textureMatrix.multiply(this.matrixWorld),this.reflectorPlane.setFromNormalAndCoplanarPoint(this.normal,this.reflectorWorldPosition),this.reflectorPlane.applyMatrix4(this.virtualCamera.matrixWorldInverse),this.clipPlane.set(this.reflectorPlane.normal.x,this.reflectorPlane.normal.y,this.reflectorPlane.normal.z,this.reflectorPlane.constant);const n=this.virtualCamera.projectionMatrix;this.q.x=(Math.sign(this.clipPlane.x)+n.elements[8])/n.elements[0],this.q.y=(Math.sign(this.clipPlane.y)+n.elements[9])/n.elements[5],this.q.z=-1,this.q.w=(1+n.elements[10])/n.elements[14],this.clipPlane.multiplyScalar(2/this.clipPlane.dot(this.q)),n.elements[2]=this.clipPlane.x,n.elements[6]=this.clipPlane.y,n.elements[10]=this.clipPlane.z+1-this.clipBias,n.elements[14]=this.clipPlane.w,this.visible=!1,this.excluded.forEach(h=>h.visible=!1);const i=s.background,r=e.getRenderTarget(),a=e.xr.enabled,o=e.shadowMap.autoUpdate,l=e.getClearAlpha();s.background=null,e.xr.enabled=!1,e.shadowMap.autoUpdate=!1,e.setRenderTarget(this.renderTarget),e.setClearAlpha(0),e.state.buffers.depth.setMask(!0),e.autoClear===!1&&e.clear(),e.render(s,this.virtualCamera),this.blur>0&&(this.blurReflector(e,this.blur),this.fastBlur||this.blurReflector(e,this.blur*.4)),e.xr.enabled=a,e.shadowMap.autoUpdate=o,s.background=i,e.setRenderTarget(r),e.setClearAlpha(l),this.excluded.forEach(h=>h.visible=!0),this.visible=!0}blurReflector(e,s){this.horizontalBlurMaterial.uniforms.tDiffuse.value=this.renderTarget.texture,this.horizontalBlurMaterial.uniforms.h.value=s*1/this.textureWidth,this.screen.material=this.horizontalBlurMaterial,e.setRenderTarget(this.renderTargetBlur),e.autoClear===!1&&e.clear(),e.render(this.screenScene,this.screenCamera),this.verticalBlurMaterial.uniforms.tDiffuse.value=this.renderTargetBlur.texture,this.verticalBlurMaterial.uniforms.v.value=s*1/this.textureHeight,this.screen.material=this.verticalBlurMaterial,e.setRenderTarget(this.renderTarget),e.autoClear===!1&&e.clear(),e.render(this.screenScene,this.screenCamera)}}It.prototype.isReflector=!0;class qs extends me{start(){this.camera.position.set(10,8,10),this.torus=new L(new Ee,new de),this.torus.position.set(2,3,-2),this.scene.add(this.torus),this.icos=new L(new je(2),new de),this.icos.position.set(-2,3,2),this.scene.add(this.icos);const e=new pe(32,32),s=new L(e,new de({depthWrite:!1}));s.rotateX(-Math.PI/2),this.scene.add(s),this.reflector=new It({opacity:1,blur:2}),this.scene.add(this.reflector)}update(e,s){this.icos.rotation.set(s/2,s/2,s/2),this.torus.rotation.set(s/2,s/2,s/2)}get parameters(){return{opacity:{label:"Opacity",value:this.reflector.opacity,min:0,max:1,onChange:e=>this.reflector.opacity=e},blur:{label:"Blur",value:this.reflector.blur,min:0,max:8,onChange:e=>this.reflector.blur=e},fast:{label:"Use fast blur",value:this.reflector.fastBlur,onChange:e=>this.reflector.fastBlur=e}}}}/**
 * potpack - by [@mourner](https://github.com/mourner)
 * 
 * A tiny JavaScript function for packing 2D rectangles into a near-square container, 
 * which is useful for generating CSS sprites and WebGL textures. Similar to 
 * [shelf-pack](https://github.com/mapbox/shelf-pack), but static (you can't add items 
 * once a layout is generated), and aims for maximal space utilization.
 *
 * A variation of algorithms used in [rectpack2D](https://github.com/TeamHypersomnia/rectpack2D)
 * and [bin-pack](https://github.com/bryanburgers/bin-pack), which are in turn based 
 * on [this article by Blackpawn](http://blackpawn.com/texts/lightmaps/default.html).
 * 
 * @license
 * ISC License
 * 
 * Copyright (c) 2018, Mapbox
 * 
 * Permission to use, copy, modify, and/or distribute this software for any purpose
 * with or without fee is hereby granted, provided that the above copyright notice
 * and this permission notice appear in all copies.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
 * REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND
 * FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
 * INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS
 * OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER
 * TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF
 * THIS SOFTWARE.
 */function Zs(d){let e=0,s=0;for(const a of d)e+=a.w*a.h,s=Math.max(s,a.w);d.sort((a,o)=>o.h-a.h);const t=Math.max(Math.ceil(Math.sqrt(e/.95)),s),n=[{x:0,y:0,w:t,h:1/0}];let i=0,r=0;for(const a of d)for(let o=n.length-1;o>=0;o--){const l=n[o];if(!(a.w>l.w||a.h>l.h)){if(a.x=l.x,a.y=l.y,r=Math.max(r,a.y+a.h),i=Math.max(i,a.x+a.w),a.w===l.w&&a.h===l.h){const h=n.pop();o<n.length&&(n[o]=h)}else a.h===l.h?(l.x+=a.w,l.w-=a.w):a.w===l.w?(l.y+=a.h,l.h-=a.h):(n.push({x:l.x+a.w,y:l.y,w:l.w-a.w,h:a.h}),l.y+=a.h,l.h-=a.h);break}}return{w:i,h:r,fill:e/(i*r)||0}}class Qs{constructor(e,s=1024){this.renderer=e,this.res=s,this.lightMapContainers=[],this.compiled=!1,this.scene=new ye,this.scene.background=null,this.tinyTarget=new re(1,1),this.buffer1Active=!1,this.firstUpdate=!0,this.warned=!1;const t=/(Android|iPad|iPhone|iPod)/g.test(navigator.userAgent)?ce:we;this.progressiveLightMap1=new re(this.res,this.res,{type:t}),this.progressiveLightMap2=new re(this.res,this.res,{type:t}),this.uvMat=new Me,this.uvMat.uniforms={},this.uvMat.onBeforeCompile=n=>{n.vertexShader=`#define USE_LIGHTMAP
`+n.vertexShader.slice(0,-1)+"	gl_Position = vec4((uv2 - 0.5) * 2.0, 1.0, 1.0); }";const i=n.fragmentShader.indexOf("void main() {");n.fragmentShader=`varying vec2 vUv2;
`+n.fragmentShader.slice(0,i)+`	uniform sampler2D previousShadowMap;
	uniform float averagingWindow;
`+n.fragmentShader.slice(i-1,-1)+`
vec3 texelOld = texture2D(previousShadowMap, vUv2).rgb;
				gl_FragColor.rgb = mix(texelOld, gl_FragColor.rgb, 1.0/averagingWindow);
			}`,n.uniforms.previousShadowMap={value:this.progressiveLightMap1.texture},n.uniforms.averagingWindow={value:100},this.uvMat.uniforms=n.uniforms,this.uvMat.userData.shader=n,this.compiled=!0}}addObjectsToLightMap(e){this.uv_boxes=[];const s=3/this.res;for(let n=0;n<e.length;n++){const i=e[n];if(i.isLight){this.scene.attach(i);continue}if(!i.geometry.hasAttribute("uv")){console.warn("All lightmap objects need UVs!");continue}this.blurringPlane==null&&this._initializeBlurPlane(this.res,this.progressiveLightMap1),i.material.lightMap=this.progressiveLightMap2.texture,i.material.dithering=!0,i.castShadow=!0,i.receiveShadow=!0,i.renderOrder=1e3+n,this.uv_boxes.push({w:1+s*2,h:1+s*2,index:n}),this.lightMapContainers.push({basicMat:i.material,object:i}),this.compiled=!1}const t=Zs(this.uv_boxes);this.uv_boxes.forEach(n=>{const i=e[n.index].geometry.getAttribute("uv").clone();for(let r=0;r<i.array.length;r+=i.itemSize)i.array[r]=(i.array[r]+n.x+s)/t.w,i.array[r+1]=(i.array[r+1]+n.y+s)/t.h;e[n.index].geometry.setAttribute("uv2",i),e[n.index].geometry.getAttribute("uv2").needsUpdate=!0})}update(e,s=100,t=!0){if(this.blurringPlane==null)return;const n=this.renderer.getRenderTarget();this.blurringPlane.visible=t;for(let a=0;a<this.lightMapContainers.length;a++)this.lightMapContainers[a].object.oldScene=this.lightMapContainers[a].object.parent,this.scene.attach(this.lightMapContainers[a].object);this.firstUpdate&&(this.renderer.setRenderTarget(this.tinyTarget),this.renderer.render(this.scene,e),this.firstUpdate=!1);for(let a=0;a<this.lightMapContainers.length;a++)this.uvMat.uniforms.averagingWindow={value:s},this.lightMapContainers[a].object.material=this.uvMat,this.lightMapContainers[a].object.oldFrustumCulled=this.lightMapContainers[a].object.frustumCulled,this.lightMapContainers[a].object.frustumCulled=!1;const i=this.buffer1Active?this.progressiveLightMap1:this.progressiveLightMap2,r=this.buffer1Active?this.progressiveLightMap2:this.progressiveLightMap1;this.renderer.setRenderTarget(i),this.uvMat.uniforms.previousShadowMap={value:r.texture},this.blurringPlane.material.uniforms.previousShadowMap={value:r.texture},this.buffer1Active=!this.buffer1Active,this.renderer.render(this.scene,e);for(let a=0;a<this.lightMapContainers.length;a++)this.lightMapContainers[a].object.frustumCulled=this.lightMapContainers[a].object.oldFrustumCulled,this.lightMapContainers[a].object.material=this.lightMapContainers[a].basicMat,this.lightMapContainers[a].object.oldScene.attach(this.lightMapContainers[a].object);this.renderer.setRenderTarget(n)}showDebugLightmap(e,s=void 0){if(this.lightMapContainers.length==0){this.warned||(console.warn("Call this after adding the objects!"),this.warned=!0);return}this.labelMesh==null&&(this.labelMaterial=new z({map:this.progressiveLightMap1.texture,side:bt}),this.labelPlane=new Ie(100,100),this.labelMesh=new L(this.labelPlane,this.labelMaterial),this.labelMesh.position.y=250,this.lightMapContainers[0].object.parent.add(this.labelMesh)),s!=null&&this.labelMesh.position.copy(s),this.labelMesh.visible=e}_initializeBlurPlane(e,s=null){const t=new z;t.uniforms={previousShadowMap:{value:null},pixelOffset:{value:1/e},polygonOffset:!0,polygonOffsetFactor:-1,polygonOffsetUnits:3},t.onBeforeCompile=n=>{n.vertexShader=`#define USE_UV
`+n.vertexShader.slice(0,-1)+"	gl_Position = vec4((uv - 0.5) * 2.0, 1.0, 1.0); }";const i=n.fragmentShader.indexOf("void main() {");n.fragmentShader=`#define USE_UV
`+n.fragmentShader.slice(0,i)+`	uniform sampler2D previousShadowMap;
	uniform float pixelOffset;
`+n.fragmentShader.slice(i-1,-1)+`	gl_FragColor.rgb = (
									texture2D(previousShadowMap, vUv + vec2( pixelOffset,  0.0        )).rgb +
									texture2D(previousShadowMap, vUv + vec2( 0.0        ,  pixelOffset)).rgb +
									texture2D(previousShadowMap, vUv + vec2( 0.0        , -pixelOffset)).rgb +
									texture2D(previousShadowMap, vUv + vec2(-pixelOffset,  0.0        )).rgb +
									texture2D(previousShadowMap, vUv + vec2( pixelOffset,  pixelOffset)).rgb +
									texture2D(previousShadowMap, vUv + vec2(-pixelOffset,  pixelOffset)).rgb +
									texture2D(previousShadowMap, vUv + vec2( pixelOffset, -pixelOffset)).rgb +
									texture2D(previousShadowMap, vUv + vec2(-pixelOffset, -pixelOffset)).rgb)/8.0;
				}`,n.uniforms.previousShadowMap={value:s.texture},n.uniforms.pixelOffset={value:.5/e},t.uniforms=n.uniforms,t.userData.shader=n,this.compiled=!0},this.blurringPlane=new L(new Ie(1,1),t),this.blurringPlane.name="Blurring Plane",this.blurringPlane.frustumCulled=!1,this.blurringPlane.renderOrder=0,this.blurringPlane.material.depthWrite=!1,this.scene.add(this.blurringPlane)}}class $s{constructor(e,{origin:s=new I(5,5,5),target:t=new I(0,1,0),center:n=new I(0,0,0),shadowMapResolution:i=512,lightMapResolution:r=1024,lightsCount:a=8,ambientWeight:o=.5,blendWindow:l=200,lightRadius:h=50}={}){this.center=n,this.origin=s,this.target=t,this.ambientWeight=o,this.blendWindow=l,this.lightRadius=h,this.progressiveSurfacemap=new Qs(e,r),this.lights=[],this.helpers=this.buildHelpers();for(let u=0;u<a;u++){const f=new vt(16777215,1/a);f.name="Dir. Light "+u,f.castShadow=!0,f.target.position.copy(t),f.shadow.mapSize.width=i,f.shadow.mapSize.height=i,this.lights.push(f)}this.progressiveSurfacemap.addObjectsToLightMap(this.lights)}buildHelpers(){new ue().add(new cs(this.target.clone().sub(this.origin).normalize(),this.origin,this.target.clone().sub(this.origin).length(),16776960,0,0),new at(new De().setFromCenterAndSize(this.origin,new I(1,1,1)),16776960),new at(new De().setFromCenterAndSize(this.target,new I(.5,.5,.5)),16776960))}add(e){Array.isArray(e)||(object=[e]),this.progressiveSurfacemap.addObjectsToLightMap(e)}render(e){this.progressiveSurfacemap.update(e,this.blendWindow,!0);for(let s=0;s<this.lights.length;s++)if(Math.random()>this.ambientWeight)this.lights[s].position.set(this.origin.x+Math.random()*this.lightRadius,this.origin.y+Math.random()*this.lightRadius,this.origin.z+Math.random()*this.lightRadius);else{const t=Math.acos(2*Math.random()-1)-1.570795,n=2*3.14159*Math.random();this.lights[s].position.set(Math.cos(t)*Math.cos(n)*300+this.center.x,Math.abs(Math.cos(t)*Math.sin(n)*300)+this.center.y+20,Math.sin(t)*300+this.center.z)}}}class Js extends me{start(){this.camera.position.set(6,10,16),this.controls.target.set(0,2,0),this.renderer.shadowMap.enabled=!0;const e=new L(new Ee(2,.75,128,24),new Me);e.position.set(2,4,-2),e.castShadow=!0,e.receiveShadow=!0,this.scene.add(e);const s=new L(new je(2),new Me);s.position.set(-2,2,2),s.castShadow=!0,s.receiveShadow=!0,this.scene.add(s);const t=new L(new pe(32,32),new Me);t.rotation.x=-Math.PI/2,this.scene.add(t),this.progressiveShadows=new $s(this.renderer,{origin:new I(5,10,5),target:new I(0,1,0),center:new I(0,0,0),shadowMapResolution:512,lightMapResolution:1024,lightsCount:8,ambientWeight:.5,blendWindow:200,lightRadius:20}),this.progressiveShadows.add([t,e,s]),this.scene.add(this.progressiveShadows.helpers)}update(e,s){this.progressiveShadows.render(this.camera)}get parameters(){return{}}}class en extends us{constructor(e){super(e),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register(function(s){return new an(s)}),this.register(function(s){return new fn(s)}),this.register(function(s){return new pn(s)}),this.register(function(s){return new ln(s)}),this.register(function(s){return new cn(s)}),this.register(function(s){return new un(s)}),this.register(function(s){return new hn(s)}),this.register(function(s){return new rn(s)}),this.register(function(s){return new dn(s)}),this.register(function(s){return new on(s)}),this.register(function(s){return new sn(s)}),this.register(function(s){return new mn(s)})}load(e,s,t,n){const i=this;let r;this.resourcePath!==""?r=this.resourcePath:this.path!==""?r=this.path:r=J.extractUrlBase(e),this.manager.itemStart(e);const a=function(l){n?n(l):console.error(l),i.manager.itemError(e),i.manager.itemEnd(e)},o=new Ke(this.manager);o.setPath(this.path),o.setResponseType("arraybuffer"),o.setRequestHeader(this.requestHeader),o.setWithCredentials(this.withCredentials),o.load(e,function(l){try{i.parse(l,r,function(h){s(h),i.manager.itemEnd(e)},a)}catch(h){a(h)}},t,a)}setDRACOLoader(e){return this.dracoLoader=e,this}setDDSLoader(){throw new Error('THREE.GLTFLoader: "MSFT_texture_dds" no longer supported. Please update to "KHR_texture_basisu".')}setKTX2Loader(e){return this.ktx2Loader=e,this}setMeshoptDecoder(e){return this.meshoptDecoder=e,this}register(e){return this.pluginCallbacks.indexOf(e)===-1&&this.pluginCallbacks.push(e),this}unregister(e){return this.pluginCallbacks.indexOf(e)!==-1&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}parse(e,s,t,n){let i;const r={},a={};if(typeof e=="string")i=e;else if(J.decodeText(new Uint8Array(e,0,4))===Ot){try{r[A.KHR_BINARY_GLTF]=new gn(e)}catch(u){n&&n(u);return}i=r[A.KHR_BINARY_GLTF].content}else i=J.decodeText(new Uint8Array(e));const o=JSON.parse(i);if(o.asset===void 0||o.asset.version[0]<2){n&&n(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported."));return}const l=new Ln(o,{path:s||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});l.fileLoader.setRequestHeader(this.requestHeader);for(let h=0;h<this.pluginCallbacks.length;h++){const u=this.pluginCallbacks[h](l);a[u.name]=u,r[u.name]=!0}if(o.extensionsUsed)for(let h=0;h<o.extensionsUsed.length;++h){const u=o.extensionsUsed[h],f=o.extensionsRequired||[];switch(u){case A.KHR_MATERIALS_UNLIT:r[u]=new nn;break;case A.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:r[u]=new wn;break;case A.KHR_DRACO_MESH_COMPRESSION:r[u]=new xn(o,this.dracoLoader);break;case A.KHR_TEXTURE_TRANSFORM:r[u]=new Tn;break;case A.KHR_MESH_QUANTIZATION:r[u]=new Mn;break;default:f.indexOf(u)>=0&&a[u]===void 0&&console.warn('THREE.GLTFLoader: Unknown extension "'+u+'".')}}l.setExtensions(r),l.setPlugins(a),l.parse(t,n)}parseAsync(e,s){const t=this;return new Promise(function(n,i){t.parse(e,s,n,i)})}}function tn(){let d={};return{get:function(e){return d[e]},add:function(e,s){d[e]=s},remove:function(e){delete d[e]},removeAll:function(){d={}}}}const A={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_IOR:"KHR_materials_ior",KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:"KHR_materials_pbrSpecularGlossiness",KHR_MATERIALS_SHEEN:"KHR_materials_sheen",KHR_MATERIALS_SPECULAR:"KHR_materials_specular",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_IRIDESCENCE:"KHR_materials_iridescence",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_MATERIALS_VOLUME:"KHR_materials_volume",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",KHR_MATERIALS_EMISSIVE_STRENGTH:"KHR_materials_emissive_strength",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression"};class sn{constructor(e){this.parser=e,this.name=A.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}_markDefs(){const e=this.parser,s=this.parser.json.nodes||[];for(let t=0,n=s.length;t<n;t++){const i=s[t];i.extensions&&i.extensions[this.name]&&i.extensions[this.name].light!==void 0&&e._addNodeRef(this.cache,i.extensions[this.name].light)}}_loadLight(e){const s=this.parser,t="light:"+e;let n=s.cache.get(t);if(n)return n;const i=s.json,o=((i.extensions&&i.extensions[this.name]||{}).lights||[])[e];let l;const h=new k(16777215);o.color!==void 0&&h.fromArray(o.color);const u=o.range!==void 0?o.range:0;switch(o.type){case"directional":l=new vt(h),l.target.position.set(0,0,-1),l.add(l.target);break;case"point":l=new Tt(h),l.distance=u;break;case"spot":l=new hs(h),l.distance=u,o.spot=o.spot||{},o.spot.innerConeAngle=o.spot.innerConeAngle!==void 0?o.spot.innerConeAngle:0,o.spot.outerConeAngle=o.spot.outerConeAngle!==void 0?o.spot.outerConeAngle:Math.PI/4,l.angle=o.spot.outerConeAngle,l.penumbra=1-o.spot.innerConeAngle/o.spot.outerConeAngle,l.target.position.set(0,0,-1),l.add(l.target);break;default:throw new Error("THREE.GLTFLoader: Unexpected light type: "+o.type)}return l.position.set(0,0,0),l.decay=2,o.intensity!==void 0&&(l.intensity=o.intensity),l.name=s.createUniqueName(o.name||"light_"+e),n=Promise.resolve(l),s.cache.add(t,n),n}createNodeAttachment(e){const s=this,t=this.parser,i=t.json.nodes[e],a=(i.extensions&&i.extensions[this.name]||{}).light;return a===void 0?null:this._loadLight(a).then(function(o){return t._getNodeRef(s.cache,a,o)})}}class nn{constructor(){this.name=A.KHR_MATERIALS_UNLIT}getMaterialType(){return z}extendParams(e,s,t){const n=[];e.color=new k(1,1,1),e.opacity=1;const i=s.pbrMetallicRoughness;if(i){if(Array.isArray(i.baseColorFactor)){const r=i.baseColorFactor;e.color.fromArray(r),e.opacity=r[3]}i.baseColorTexture!==void 0&&n.push(t.assignTexture(e,"map",i.baseColorTexture,Z))}return Promise.all(n)}}class rn{constructor(e){this.parser=e,this.name=A.KHR_MATERIALS_EMISSIVE_STRENGTH}extendMaterialParams(e,s){const n=this.parser.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=n.extensions[this.name].emissiveStrength;return i!==void 0&&(s.emissiveIntensity=i),Promise.resolve()}}class an{constructor(e){this.parser=e,this.name=A.KHR_MATERIALS_CLEARCOAT}getMaterialType(e){const t=this.parser.json.materials[e];return!t.extensions||!t.extensions[this.name]?null:te}extendMaterialParams(e,s){const t=this.parser,n=t.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=[],r=n.extensions[this.name];if(r.clearcoatFactor!==void 0&&(s.clearcoat=r.clearcoatFactor),r.clearcoatTexture!==void 0&&i.push(t.assignTexture(s,"clearcoatMap",r.clearcoatTexture)),r.clearcoatRoughnessFactor!==void 0&&(s.clearcoatRoughness=r.clearcoatRoughnessFactor),r.clearcoatRoughnessTexture!==void 0&&i.push(t.assignTexture(s,"clearcoatRoughnessMap",r.clearcoatRoughnessTexture)),r.clearcoatNormalTexture!==void 0&&(i.push(t.assignTexture(s,"clearcoatNormalMap",r.clearcoatNormalTexture)),r.clearcoatNormalTexture.scale!==void 0)){const a=r.clearcoatNormalTexture.scale;s.clearcoatNormalScale=new K(a,a)}return Promise.all(i)}}class on{constructor(e){this.parser=e,this.name=A.KHR_MATERIALS_IRIDESCENCE}getMaterialType(e){const t=this.parser.json.materials[e];return!t.extensions||!t.extensions[this.name]?null:te}extendMaterialParams(e,s){const t=this.parser,n=t.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=[],r=n.extensions[this.name];return r.iridescenceFactor!==void 0&&(s.iridescence=r.iridescenceFactor),r.iridescenceTexture!==void 0&&i.push(t.assignTexture(s,"iridescenceMap",r.iridescenceTexture)),r.iridescenceIor!==void 0&&(s.iridescenceIOR=r.iridescenceIor),s.iridescenceThicknessRange===void 0&&(s.iridescenceThicknessRange=[100,400]),r.iridescenceThicknessMinimum!==void 0&&(s.iridescenceThicknessRange[0]=r.iridescenceThicknessMinimum),r.iridescenceThicknessMaximum!==void 0&&(s.iridescenceThicknessRange[1]=r.iridescenceThicknessMaximum),r.iridescenceThicknessTexture!==void 0&&i.push(t.assignTexture(s,"iridescenceThicknessMap",r.iridescenceThicknessTexture)),Promise.all(i)}}class ln{constructor(e){this.parser=e,this.name=A.KHR_MATERIALS_SHEEN}getMaterialType(e){const t=this.parser.json.materials[e];return!t.extensions||!t.extensions[this.name]?null:te}extendMaterialParams(e,s){const t=this.parser,n=t.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=[];s.sheenColor=new k(0,0,0),s.sheenRoughness=0,s.sheen=1;const r=n.extensions[this.name];return r.sheenColorFactor!==void 0&&s.sheenColor.fromArray(r.sheenColorFactor),r.sheenRoughnessFactor!==void 0&&(s.sheenRoughness=r.sheenRoughnessFactor),r.sheenColorTexture!==void 0&&i.push(t.assignTexture(s,"sheenColorMap",r.sheenColorTexture,Z)),r.sheenRoughnessTexture!==void 0&&i.push(t.assignTexture(s,"sheenRoughnessMap",r.sheenRoughnessTexture)),Promise.all(i)}}class cn{constructor(e){this.parser=e,this.name=A.KHR_MATERIALS_TRANSMISSION}getMaterialType(e){const t=this.parser.json.materials[e];return!t.extensions||!t.extensions[this.name]?null:te}extendMaterialParams(e,s){const t=this.parser,n=t.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=[],r=n.extensions[this.name];return r.transmissionFactor!==void 0&&(s.transmission=r.transmissionFactor),r.transmissionTexture!==void 0&&i.push(t.assignTexture(s,"transmissionMap",r.transmissionTexture)),Promise.all(i)}}class un{constructor(e){this.parser=e,this.name=A.KHR_MATERIALS_VOLUME}getMaterialType(e){const t=this.parser.json.materials[e];return!t.extensions||!t.extensions[this.name]?null:te}extendMaterialParams(e,s){const t=this.parser,n=t.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=[],r=n.extensions[this.name];s.thickness=r.thicknessFactor!==void 0?r.thicknessFactor:0,r.thicknessTexture!==void 0&&i.push(t.assignTexture(s,"thicknessMap",r.thicknessTexture)),s.attenuationDistance=r.attenuationDistance||1/0;const a=r.attenuationColor||[1,1,1];return s.attenuationColor=new k(a[0],a[1],a[2]),Promise.all(i)}}class hn{constructor(e){this.parser=e,this.name=A.KHR_MATERIALS_IOR}getMaterialType(e){const t=this.parser.json.materials[e];return!t.extensions||!t.extensions[this.name]?null:te}extendMaterialParams(e,s){const n=this.parser.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=n.extensions[this.name];return s.ior=i.ior!==void 0?i.ior:1.5,Promise.resolve()}}class dn{constructor(e){this.parser=e,this.name=A.KHR_MATERIALS_SPECULAR}getMaterialType(e){const t=this.parser.json.materials[e];return!t.extensions||!t.extensions[this.name]?null:te}extendMaterialParams(e,s){const t=this.parser,n=t.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=[],r=n.extensions[this.name];s.specularIntensity=r.specularFactor!==void 0?r.specularFactor:1,r.specularTexture!==void 0&&i.push(t.assignTexture(s,"specularIntensityMap",r.specularTexture));const a=r.specularColorFactor||[1,1,1];return s.specularColor=new k(a[0],a[1],a[2]),r.specularColorTexture!==void 0&&i.push(t.assignTexture(s,"specularColorMap",r.specularColorTexture,Z)),Promise.all(i)}}class fn{constructor(e){this.parser=e,this.name=A.KHR_TEXTURE_BASISU}loadTexture(e){const s=this.parser,t=s.json,n=t.textures[e];if(!n.extensions||!n.extensions[this.name])return null;const i=n.extensions[this.name],r=s.options.ktx2Loader;if(!r){if(t.extensionsRequired&&t.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures");return null}return s.loadTextureImage(e,i.source,r)}}class pn{constructor(e){this.parser=e,this.name=A.EXT_TEXTURE_WEBP,this.isSupported=null}loadTexture(e){const s=this.name,t=this.parser,n=t.json,i=n.textures[e];if(!i.extensions||!i.extensions[s])return null;const r=i.extensions[s],a=n.images[r.source];let o=t.textureLoader;if(a.uri){const l=t.options.manager.getHandler(a.uri);l!==null&&(o=l)}return this.detectSupport().then(function(l){if(l)return t.loadTextureImage(e,r.source,o);if(n.extensionsRequired&&n.extensionsRequired.indexOf(s)>=0)throw new Error("THREE.GLTFLoader: WebP required by asset but unsupported.");return t.loadTexture(e)})}detectSupport(){return this.isSupported||(this.isSupported=new Promise(function(e){const s=new Image;s.src="data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA",s.onload=s.onerror=function(){e(s.height===1)}})),this.isSupported}}class mn{constructor(e){this.name=A.EXT_MESHOPT_COMPRESSION,this.parser=e}loadBufferView(e){const s=this.parser.json,t=s.bufferViews[e];if(t.extensions&&t.extensions[this.name]){const n=t.extensions[this.name],i=this.parser.getDependency("buffer",n.buffer),r=this.parser.options.meshoptDecoder;if(!r||!r.supported){if(s.extensionsRequired&&s.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files");return null}return i.then(function(a){const o=n.byteOffset||0,l=n.byteLength||0,h=n.count,u=n.byteStride,f=new Uint8Array(a,o,l);return r.decodeGltfBufferAsync?r.decodeGltfBufferAsync(h,u,f,n.mode,n.filter).then(function(p){return p.buffer}):r.ready.then(function(){const p=new ArrayBuffer(h*u);return r.decodeGltfBuffer(new Uint8Array(p),h,u,f,n.mode,n.filter),p})})}else return null}}const Ot="glTF",oe=12,ht={JSON:1313821514,BIN:5130562};class gn{constructor(e){this.name=A.KHR_BINARY_GLTF,this.content=null,this.body=null;const s=new DataView(e,0,oe);if(this.header={magic:J.decodeText(new Uint8Array(e.slice(0,4))),version:s.getUint32(4,!0),length:s.getUint32(8,!0)},this.header.magic!==Ot)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");const t=this.header.length-oe,n=new DataView(e,oe);let i=0;for(;i<t;){const r=n.getUint32(i,!0);i+=4;const a=n.getUint32(i,!0);if(i+=4,a===ht.JSON){const o=new Uint8Array(e,oe+i,r);this.content=J.decodeText(o)}else if(a===ht.BIN){const o=oe+i;this.body=e.slice(o,o+r)}i+=r}if(this.content===null)throw new Error("THREE.GLTFLoader: JSON content not found.")}}class xn{constructor(e,s){if(!s)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=A.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=s,this.dracoLoader.preload()}decodePrimitive(e,s){const t=this.json,n=this.dracoLoader,i=e.extensions[this.name].bufferView,r=e.extensions[this.name].attributes,a={},o={},l={};for(const h in r){const u=Ue[h]||h.toLowerCase();a[u]=r[h]}for(const h in e.attributes){const u=Ue[h]||h.toLowerCase();if(r[h]!==void 0){const f=t.accessors[e.attributes[h]],p=fe[f.componentType];l[u]=p.name,o[u]=f.normalized===!0}}return s.getDependency("bufferView",i).then(function(h){return new Promise(function(u){n.decodeDracoFile(h,function(f){for(const p in f.attributes){const w=f.attributes[p],E=o[p];E!==void 0&&(w.normalized=E)}u(f)},a,l)})})}}class Tn{constructor(){this.name=A.KHR_TEXTURE_TRANSFORM}extendTexture(e,s){return s.texCoord!==void 0&&console.warn('THREE.GLTFLoader: Custom UV sets in "'+this.name+'" extension not yet supported.'),s.offset===void 0&&s.rotation===void 0&&s.scale===void 0||(e=e.clone(),s.offset!==void 0&&e.offset.fromArray(s.offset),s.rotation!==void 0&&(e.rotation=s.rotation),s.scale!==void 0&&e.repeat.fromArray(s.scale),e.needsUpdate=!0),e}}class Fe extends ee{constructor(e){super(),this.isGLTFSpecularGlossinessMaterial=!0;const s=["#ifdef USE_SPECULARMAP","	uniform sampler2D specularMap;","#endif"].join(`
`),t=["#ifdef USE_GLOSSINESSMAP","	uniform sampler2D glossinessMap;","#endif"].join(`
`),n=["vec3 specularFactor = specular;","#ifdef USE_SPECULARMAP","	vec4 texelSpecular = texture2D( specularMap, vUv );","	// reads channel RGB, compatible with a glTF Specular-Glossiness (RGBA) texture","	specularFactor *= texelSpecular.rgb;","#endif"].join(`
`),i=["float glossinessFactor = glossiness;","#ifdef USE_GLOSSINESSMAP","	vec4 texelGlossiness = texture2D( glossinessMap, vUv );","	// reads channel A, compatible with a glTF Specular-Glossiness (RGBA) texture","	glossinessFactor *= texelGlossiness.a;","#endif"].join(`
`),r=["PhysicalMaterial material;","material.diffuseColor = diffuseColor.rgb * ( 1. - max( specularFactor.r, max( specularFactor.g, specularFactor.b ) ) );","vec3 dxy = max( abs( dFdx( geometryNormal ) ), abs( dFdy( geometryNormal ) ) );","float geometryRoughness = max( max( dxy.x, dxy.y ), dxy.z );","material.roughness = max( 1.0 - glossinessFactor, 0.0525 ); // 0.0525 corresponds to the base mip of a 256 cubemap.","material.roughness += geometryRoughness;","material.roughness = min( material.roughness, 1.0 );","material.specularColor = specularFactor;"].join(`
`),a={specular:{value:new k().setHex(16777215)},glossiness:{value:1},specularMap:{value:null},glossinessMap:{value:null}};this._extraUniforms=a,this.onBeforeCompile=function(o){for(const l in a)o.uniforms[l]=a[l];o.fragmentShader=o.fragmentShader.replace("uniform float roughness;","uniform vec3 specular;").replace("uniform float metalness;","uniform float glossiness;").replace("#include <roughnessmap_pars_fragment>",s).replace("#include <metalnessmap_pars_fragment>",t).replace("#include <roughnessmap_fragment>",n).replace("#include <metalnessmap_fragment>",i).replace("#include <lights_physical_fragment>",r)},Object.defineProperties(this,{specular:{get:function(){return a.specular.value},set:function(o){a.specular.value=o}},specularMap:{get:function(){return a.specularMap.value},set:function(o){a.specularMap.value=o,o?this.defines.USE_SPECULARMAP="":delete this.defines.USE_SPECULARMAP}},glossiness:{get:function(){return a.glossiness.value},set:function(o){a.glossiness.value=o}},glossinessMap:{get:function(){return a.glossinessMap.value},set:function(o){a.glossinessMap.value=o,o?(this.defines.USE_GLOSSINESSMAP="",this.defines.USE_UV=""):(delete this.defines.USE_GLOSSINESSMAP,delete this.defines.USE_UV)}}}),delete this.metalness,delete this.roughness,delete this.metalnessMap,delete this.roughnessMap,this.setValues(e)}copy(e){return super.copy(e),this.specularMap=e.specularMap,this.specular.copy(e.specular),this.glossinessMap=e.glossinessMap,this.glossiness=e.glossiness,delete this.metalness,delete this.roughness,delete this.metalnessMap,delete this.roughnessMap,this}}class wn{constructor(){this.name=A.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS,this.specularGlossinessParams=["color","map","lightMap","lightMapIntensity","aoMap","aoMapIntensity","emissive","emissiveIntensity","emissiveMap","bumpMap","bumpScale","normalMap","normalMapType","displacementMap","displacementScale","displacementBias","specularMap","specular","glossinessMap","glossiness","alphaMap","envMap","envMapIntensity"]}getMaterialType(){return Fe}extendParams(e,s,t){const n=s.extensions[this.name];e.color=new k(1,1,1),e.opacity=1;const i=[];if(Array.isArray(n.diffuseFactor)){const r=n.diffuseFactor;e.color.fromArray(r),e.opacity=r[3]}if(n.diffuseTexture!==void 0&&i.push(t.assignTexture(e,"map",n.diffuseTexture,Z)),e.emissive=new k(0,0,0),e.glossiness=n.glossinessFactor!==void 0?n.glossinessFactor:1,e.specular=new k(1,1,1),Array.isArray(n.specularFactor)&&e.specular.fromArray(n.specularFactor),n.specularGlossinessTexture!==void 0){const r=n.specularGlossinessTexture;i.push(t.assignTexture(e,"glossinessMap",r)),i.push(t.assignTexture(e,"specularMap",r,Z))}return Promise.all(i)}createMaterial(e){const s=new Fe(e);return s.fog=!0,s.color=e.color,s.map=e.map===void 0?null:e.map,s.lightMap=null,s.lightMapIntensity=1,s.aoMap=e.aoMap===void 0?null:e.aoMap,s.aoMapIntensity=1,s.emissive=e.emissive,s.emissiveIntensity=e.emissiveIntensity===void 0?1:e.emissiveIntensity,s.emissiveMap=e.emissiveMap===void 0?null:e.emissiveMap,s.bumpMap=e.bumpMap===void 0?null:e.bumpMap,s.bumpScale=1,s.normalMap=e.normalMap===void 0?null:e.normalMap,s.normalMapType=ds,e.normalScale&&(s.normalScale=e.normalScale),s.displacementMap=null,s.displacementScale=1,s.displacementBias=0,s.specularMap=e.specularMap===void 0?null:e.specularMap,s.specular=e.specular,s.glossinessMap=e.glossinessMap===void 0?null:e.glossinessMap,s.glossiness=e.glossiness,s.alphaMap=null,s.envMap=e.envMap===void 0?null:e.envMap,s.envMapIntensity=1,s}}class Mn{constructor(){this.name=A.KHR_MESH_QUANTIZATION}}class Dt extends Bs{constructor(e,s,t,n){super(e,s,t,n)}copySampleValue_(e){const s=this.resultBuffer,t=this.sampleValues,n=this.valueSize,i=e*n*3+n;for(let r=0;r!==n;r++)s[r]=t[i+r];return s}interpolate_(e,s,t,n){const i=this.resultBuffer,r=this.sampleValues,a=this.valueSize,o=a*2,l=a*3,h=n-s,u=(t-s)/h,f=u*u,p=f*u,w=e*l,E=w-l,x=-2*p+3*f,T=p-f,P=1-x,m=T-f+u;for(let v=0;v!==a;v++){const g=r[E+v+a],S=r[E+v+o]*h,_=r[w+v+a],R=r[w+v]*h;i[v]=P*g+m*S+x*_+T*R}return i}}const bn=new Ce;class vn extends Dt{interpolate_(e,s,t,n){const i=super.interpolate_(e,s,t,n);return bn.fromArray(i).normalize().toArray(i),i}}const X={FLOAT:5126,FLOAT_MAT3:35675,FLOAT_MAT4:35676,FLOAT_VEC2:35664,FLOAT_VEC3:35665,FLOAT_VEC4:35666,LINEAR:9729,REPEAT:10497,SAMPLER_2D:35678,POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6,UNSIGNED_BYTE:5121,UNSIGNED_SHORT:5123},fe={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},dt={9728:_s,9729:ae,9984:As,9985:Ls,9986:Ps,9987:Et},ft={33071:Cs,33648:Is,10497:Ne},pt={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},Ue={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv2",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},q={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},yn={CUBICSPLINE:void 0,LINEAR:St,STEP:Os},Pe={OPAQUE:"OPAQUE",MASK:"MASK",BLEND:"BLEND"};function En(d){return d.DefaultMaterial===void 0&&(d.DefaultMaterial=new ee({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:Ds})),d.DefaultMaterial}function le(d,e,s){for(const t in s.extensions)d[t]===void 0&&(e.userData.gltfExtensions=e.userData.gltfExtensions||{},e.userData.gltfExtensions[t]=s.extensions[t])}function $(d,e){e.extras!==void 0&&(typeof e.extras=="object"?Object.assign(d.userData,e.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+e.extras))}function Sn(d,e,s){let t=!1,n=!1,i=!1;for(let l=0,h=e.length;l<h;l++){const u=e[l];if(u.POSITION!==void 0&&(t=!0),u.NORMAL!==void 0&&(n=!0),u.COLOR_0!==void 0&&(i=!0),t&&n&&i)break}if(!t&&!n&&!i)return Promise.resolve(d);const r=[],a=[],o=[];for(let l=0,h=e.length;l<h;l++){const u=e[l];if(t){const f=u.POSITION!==void 0?s.getDependency("accessor",u.POSITION):d.attributes.position;r.push(f)}if(n){const f=u.NORMAL!==void 0?s.getDependency("accessor",u.NORMAL):d.attributes.normal;a.push(f)}if(i){const f=u.COLOR_0!==void 0?s.getDependency("accessor",u.COLOR_0):d.attributes.color;o.push(f)}}return Promise.all([Promise.all(r),Promise.all(a),Promise.all(o)]).then(function(l){const h=l[0],u=l[1],f=l[2];return t&&(d.morphAttributes.position=h),n&&(d.morphAttributes.normal=u),i&&(d.morphAttributes.color=f),d.morphTargetsRelative=!0,d})}function Rn(d,e){if(d.updateMorphTargets(),e.weights!==void 0)for(let s=0,t=e.weights.length;s<t;s++)d.morphTargetInfluences[s]=e.weights[s];if(e.extras&&Array.isArray(e.extras.targetNames)){const s=e.extras.targetNames;if(d.morphTargetInfluences.length===s.length){d.morphTargetDictionary={};for(let t=0,n=s.length;t<n;t++)d.morphTargetDictionary[s[t]]=t}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}function _n(d){const e=d.extensions&&d.extensions[A.KHR_DRACO_MESH_COMPRESSION];let s;return e?s="draco:"+e.bufferView+":"+e.indices+":"+mt(e.attributes):s=d.indices+":"+mt(d.attributes)+":"+d.mode,s}function mt(d){let e="";const s=Object.keys(d).sort();for(let t=0,n=s.length;t<n;t++)e+=s[t]+":"+d[s[t]]+";";return e}function ke(d){switch(d){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw new Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}function An(d){return d.search(/\.jpe?g($|\?)/i)>0||d.search(/^data\:image\/jpeg/)===0?"image/jpeg":d.search(/\.webp($|\?)/i)>0||d.search(/^data\:image\/webp/)===0?"image/webp":"image/png"}class Ln{constructor(e={},s={}){this.json=e,this.extensions={},this.plugins={},this.options=s,this.cache=new tn,this.associations=new Map,this.primitiveCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.sourceCache={},this.textureCache={},this.nodeNamesUsed={};const t=/^((?!chrome|android).)*safari/i.test(navigator.userAgent)===!0,n=navigator.userAgent.indexOf("Firefox")>-1,i=n?navigator.userAgent.match(/Firefox\/([0-9]+)\./)[1]:-1;typeof createImageBitmap>"u"||t||n&&i<98?this.textureLoader=new yt(this.options.manager):this.textureLoader=new fs(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new Ke(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),this.options.crossOrigin==="use-credentials"&&this.fileLoader.setWithCredentials(!0)}setExtensions(e){this.extensions=e}setPlugins(e){this.plugins=e}parse(e,s){const t=this,n=this.json,i=this.extensions;this.cache.removeAll(),this._invokeAll(function(r){return r._markDefs&&r._markDefs()}),Promise.all(this._invokeAll(function(r){return r.beforeRoot&&r.beforeRoot()})).then(function(){return Promise.all([t.getDependencies("scene"),t.getDependencies("animation"),t.getDependencies("camera")])}).then(function(r){const a={scene:r[0][n.scene||0],scenes:r[0],animations:r[1],cameras:r[2],asset:n.asset,parser:t,userData:{}};le(i,a,n),$(a,n),Promise.all(t._invokeAll(function(o){return o.afterRoot&&o.afterRoot(a)})).then(function(){e(a)})}).catch(s)}_markDefs(){const e=this.json.nodes||[],s=this.json.skins||[],t=this.json.meshes||[];for(let n=0,i=s.length;n<i;n++){const r=s[n].joints;for(let a=0,o=r.length;a<o;a++)e[r[a]].isBone=!0}for(let n=0,i=e.length;n<i;n++){const r=e[n];r.mesh!==void 0&&(this._addNodeRef(this.meshCache,r.mesh),r.skin!==void 0&&(t[r.mesh].isSkinnedMesh=!0)),r.camera!==void 0&&this._addNodeRef(this.cameraCache,r.camera)}}_addNodeRef(e,s){s!==void 0&&(e.refs[s]===void 0&&(e.refs[s]=e.uses[s]=0),e.refs[s]++)}_getNodeRef(e,s,t){if(e.refs[s]<=1)return t;const n=t.clone(),i=(r,a)=>{const o=this.associations.get(r);o!=null&&this.associations.set(a,o);for(const[l,h]of r.children.entries())i(h,a.children[l])};return i(t,n),n.name+="_instance_"+e.uses[s]++,n}_invokeOne(e){const s=Object.values(this.plugins);s.push(this);for(let t=0;t<s.length;t++){const n=e(s[t]);if(n)return n}return null}_invokeAll(e){const s=Object.values(this.plugins);s.unshift(this);const t=[];for(let n=0;n<s.length;n++){const i=e(s[n]);i&&t.push(i)}return t}getDependency(e,s){const t=e+":"+s;let n=this.cache.get(t);if(!n){switch(e){case"scene":n=this.loadScene(s);break;case"node":n=this.loadNode(s);break;case"mesh":n=this._invokeOne(function(i){return i.loadMesh&&i.loadMesh(s)});break;case"accessor":n=this.loadAccessor(s);break;case"bufferView":n=this._invokeOne(function(i){return i.loadBufferView&&i.loadBufferView(s)});break;case"buffer":n=this.loadBuffer(s);break;case"material":n=this._invokeOne(function(i){return i.loadMaterial&&i.loadMaterial(s)});break;case"texture":n=this._invokeOne(function(i){return i.loadTexture&&i.loadTexture(s)});break;case"skin":n=this.loadSkin(s);break;case"animation":n=this._invokeOne(function(i){return i.loadAnimation&&i.loadAnimation(s)});break;case"camera":n=this.loadCamera(s);break;default:throw new Error("Unknown type: "+e)}this.cache.add(t,n)}return n}getDependencies(e){let s=this.cache.get(e);if(!s){const t=this,n=this.json[e+(e==="mesh"?"es":"s")]||[];s=Promise.all(n.map(function(i,r){return t.getDependency(e,r)})),this.cache.add(e,s)}return s}loadBuffer(e){const s=this.json.buffers[e],t=this.fileLoader;if(s.type&&s.type!=="arraybuffer")throw new Error("THREE.GLTFLoader: "+s.type+" buffer type is not supported.");if(s.uri===void 0&&e===0)return Promise.resolve(this.extensions[A.KHR_BINARY_GLTF].body);const n=this.options;return new Promise(function(i,r){t.load(J.resolveURL(s.uri,n.path),i,void 0,function(){r(new Error('THREE.GLTFLoader: Failed to load buffer "'+s.uri+'".'))})})}loadBufferView(e){const s=this.json.bufferViews[e];return this.getDependency("buffer",s.buffer).then(function(t){const n=s.byteLength||0,i=s.byteOffset||0;return t.slice(i,i+n)})}loadAccessor(e){const s=this,t=this.json,n=this.json.accessors[e];if(n.bufferView===void 0&&n.sparse===void 0)return Promise.resolve(null);const i=[];return n.bufferView!==void 0?i.push(this.getDependency("bufferView",n.bufferView)):i.push(null),n.sparse!==void 0&&(i.push(this.getDependency("bufferView",n.sparse.indices.bufferView)),i.push(this.getDependency("bufferView",n.sparse.values.bufferView))),Promise.all(i).then(function(r){const a=r[0],o=pt[n.type],l=fe[n.componentType],h=l.BYTES_PER_ELEMENT,u=h*o,f=n.byteOffset||0,p=n.bufferView!==void 0?t.bufferViews[n.bufferView].byteStride:void 0,w=n.normalized===!0;let E,x;if(p&&p!==u){const T=Math.floor(f/p),P="InterleavedBuffer:"+n.bufferView+":"+n.componentType+":"+T+":"+n.count;let m=s.cache.get(P);m||(E=new l(a,T*p,n.count*p/h),m=new ps(E,p/h),s.cache.add(P,m)),x=new Ns(m,o,f%p/h,w)}else a===null?E=new l(n.count*o):E=new l(a,f,n.count*o),x=new ve(E,o,w);if(n.sparse!==void 0){const T=pt.SCALAR,P=fe[n.sparse.indices.componentType],m=n.sparse.indices.byteOffset||0,v=n.sparse.values.byteOffset||0,g=new P(r[1],m,n.sparse.count*T),S=new l(r[2],v,n.sparse.count*o);a!==null&&(x=new ve(x.array.slice(),x.itemSize,x.normalized));for(let _=0,R=g.length;_<R;_++){const M=g[_];if(x.setX(M,S[_*o]),o>=2&&x.setY(M,S[_*o+1]),o>=3&&x.setZ(M,S[_*o+2]),o>=4&&x.setW(M,S[_*o+3]),o>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}}return x})}loadTexture(e){const s=this.json,t=this.options,i=s.textures[e].source,r=s.images[i];let a=this.textureLoader;if(r.uri){const o=t.manager.getHandler(r.uri);o!==null&&(a=o)}return this.loadTextureImage(e,i,a)}loadTextureImage(e,s,t){const n=this,i=this.json,r=i.textures[e],a=i.images[s],o=(a.uri||a.bufferView)+":"+r.sampler;if(this.textureCache[o])return this.textureCache[o];const l=this.loadImageSource(s,t).then(function(h){h.flipY=!1,r.name&&(h.name=r.name);const f=(i.samplers||{})[r.sampler]||{};return h.magFilter=dt[f.magFilter]||ae,h.minFilter=dt[f.minFilter]||Et,h.wrapS=ft[f.wrapS]||Ne,h.wrapT=ft[f.wrapT]||Ne,n.associations.set(h,{textures:e}),h}).catch(function(){return null});return this.textureCache[o]=l,l}loadImageSource(e,s){const t=this,n=this.json,i=this.options;if(this.sourceCache[e]!==void 0)return this.sourceCache[e].then(u=>u.clone());const r=n.images[e],a=self.URL||self.webkitURL;let o=r.uri||"",l=!1;if(r.bufferView!==void 0)o=t.getDependency("bufferView",r.bufferView).then(function(u){l=!0;const f=new Blob([u],{type:r.mimeType});return o=a.createObjectURL(f),o});else if(r.uri===void 0)throw new Error("THREE.GLTFLoader: Image "+e+" is missing URI and bufferView");const h=Promise.resolve(o).then(function(u){return new Promise(function(f,p){let w=f;s.isImageBitmapLoader===!0&&(w=function(E){const x=new ot(E);x.needsUpdate=!0,f(x)}),s.load(J.resolveURL(u,i.path),w,void 0,p)})}).then(function(u){return l===!0&&a.revokeObjectURL(o),u.userData.mimeType=r.mimeType||An(r.uri),u}).catch(function(u){throw console.error("THREE.GLTFLoader: Couldn't load texture",o),u});return this.sourceCache[e]=h,h}assignTexture(e,s,t,n){const i=this;return this.getDependency("texture",t.index).then(function(r){if(t.texCoord!==void 0&&t.texCoord!=0&&!(s==="aoMap"&&t.texCoord==1)&&console.warn("THREE.GLTFLoader: Custom UV set "+t.texCoord+" for texture "+s+" not yet supported."),i.extensions[A.KHR_TEXTURE_TRANSFORM]){const a=t.extensions!==void 0?t.extensions[A.KHR_TEXTURE_TRANSFORM]:void 0;if(a){const o=i.associations.get(r);r=i.extensions[A.KHR_TEXTURE_TRANSFORM].extendTexture(r,a),i.associations.set(r,o)}}return n!==void 0&&(r.encoding=n),e[s]=r,r})}assignFinalMaterial(e){const s=e.geometry;let t=e.material;const n=s.attributes.tangent===void 0,i=s.attributes.color!==void 0,r=s.attributes.normal===void 0;if(e.isPoints){const a="PointsMaterial:"+t.uuid;let o=this.cache.get(a);o||(o=new ms,Ae.prototype.copy.call(o,t),o.color.copy(t.color),o.map=t.map,o.sizeAttenuation=!1,this.cache.add(a,o)),t=o}else if(e.isLine){const a="LineBasicMaterial:"+t.uuid;let o=this.cache.get(a);o||(o=new gs,Ae.prototype.copy.call(o,t),o.color.copy(t.color),this.cache.add(a,o)),t=o}if(n||i||r){let a="ClonedMaterial:"+t.uuid+":";t.isGLTFSpecularGlossinessMaterial&&(a+="specular-glossiness:"),n&&(a+="derivative-tangents:"),i&&(a+="vertex-colors:"),r&&(a+="flat-shading:");let o=this.cache.get(a);o||(o=t.clone(),i&&(o.vertexColors=!0),r&&(o.flatShading=!0),n&&(o.normalScale&&(o.normalScale.y*=-1),o.clearcoatNormalScale&&(o.clearcoatNormalScale.y*=-1)),this.cache.add(a,o),this.associations.set(o,this.associations.get(t))),t=o}t.aoMap&&s.attributes.uv2===void 0&&s.attributes.uv!==void 0&&s.setAttribute("uv2",s.attributes.uv),e.material=t}getMaterialType(){return ee}loadMaterial(e){const s=this,t=this.json,n=this.extensions,i=t.materials[e];let r;const a={},o=i.extensions||{},l=[];if(o[A.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS]){const u=n[A.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS];r=u.getMaterialType(),l.push(u.extendParams(a,i,s))}else if(o[A.KHR_MATERIALS_UNLIT]){const u=n[A.KHR_MATERIALS_UNLIT];r=u.getMaterialType(),l.push(u.extendParams(a,i,s))}else{const u=i.pbrMetallicRoughness||{};if(a.color=new k(1,1,1),a.opacity=1,Array.isArray(u.baseColorFactor)){const f=u.baseColorFactor;a.color.fromArray(f),a.opacity=f[3]}u.baseColorTexture!==void 0&&l.push(s.assignTexture(a,"map",u.baseColorTexture,Z)),a.metalness=u.metallicFactor!==void 0?u.metallicFactor:1,a.roughness=u.roughnessFactor!==void 0?u.roughnessFactor:1,u.metallicRoughnessTexture!==void 0&&(l.push(s.assignTexture(a,"metalnessMap",u.metallicRoughnessTexture)),l.push(s.assignTexture(a,"roughnessMap",u.metallicRoughnessTexture))),r=this._invokeOne(function(f){return f.getMaterialType&&f.getMaterialType(e)}),l.push(Promise.all(this._invokeAll(function(f){return f.extendMaterialParams&&f.extendMaterialParams(e,a)})))}i.doubleSided===!0&&(a.side=bt);const h=i.alphaMode||Pe.OPAQUE;if(h===Pe.BLEND?(a.transparent=!0,a.depthWrite=!1):(a.transparent=!1,h===Pe.MASK&&(a.alphaTest=i.alphaCutoff!==void 0?i.alphaCutoff:.5)),i.normalTexture!==void 0&&r!==z&&(l.push(s.assignTexture(a,"normalMap",i.normalTexture)),a.normalScale=new K(1,1),i.normalTexture.scale!==void 0)){const u=i.normalTexture.scale;a.normalScale.set(u,u)}return i.occlusionTexture!==void 0&&r!==z&&(l.push(s.assignTexture(a,"aoMap",i.occlusionTexture)),i.occlusionTexture.strength!==void 0&&(a.aoMapIntensity=i.occlusionTexture.strength)),i.emissiveFactor!==void 0&&r!==z&&(a.emissive=new k().fromArray(i.emissiveFactor)),i.emissiveTexture!==void 0&&r!==z&&l.push(s.assignTexture(a,"emissiveMap",i.emissiveTexture,Z)),Promise.all(l).then(function(){let u;return r===Fe?u=n[A.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS].createMaterial(a):u=new r(a),i.name&&(u.name=i.name),$(u,i),s.associations.set(u,{materials:e}),i.extensions&&le(n,u,i),u})}createUniqueName(e){const s=xs.sanitizeNodeName(e||"");let t=s;for(let n=1;this.nodeNamesUsed[t];++n)t=s+"_"+n;return this.nodeNamesUsed[t]=!0,t}loadGeometries(e){const s=this,t=this.extensions,n=this.primitiveCache;function i(a){return t[A.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(a,s).then(function(o){return gt(o,a,s)})}const r=[];for(let a=0,o=e.length;a<o;a++){const l=e[a],h=_n(l),u=n[h];if(u)r.push(u.promise);else{let f;l.extensions&&l.extensions[A.KHR_DRACO_MESH_COMPRESSION]?f=i(l):f=gt(new Mt,l,s),n[h]={primitive:l,promise:f},r.push(f)}}return Promise.all(r)}loadMesh(e){const s=this,t=this.json,n=this.extensions,i=t.meshes[e],r=i.primitives,a=[];for(let o=0,l=r.length;o<l;o++){const h=r[o].material===void 0?En(this.cache):this.getDependency("material",r[o].material);a.push(h)}return a.push(s.loadGeometries(r)),Promise.all(a).then(function(o){const l=o.slice(0,o.length-1),h=o[o.length-1],u=[];for(let p=0,w=h.length;p<w;p++){const E=h[p],x=r[p];let T;const P=l[p];if(x.mode===X.TRIANGLES||x.mode===X.TRIANGLE_STRIP||x.mode===X.TRIANGLE_FAN||x.mode===void 0)T=i.isSkinnedMesh===!0?new Ts(E,P):new L(E,P),T.isSkinnedMesh===!0&&!T.geometry.attributes.skinWeight.normalized&&T.normalizeSkinWeights(),x.mode===X.TRIANGLE_STRIP?T.geometry=xt(T.geometry,Fs):x.mode===X.TRIANGLE_FAN&&(T.geometry=xt(T.geometry,Rt));else if(x.mode===X.LINES)T=new ws(E,P);else if(x.mode===X.LINE_STRIP)T=new Ms(E,P);else if(x.mode===X.LINE_LOOP)T=new bs(E,P);else if(x.mode===X.POINTS)T=new vs(E,P);else throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+x.mode);Object.keys(T.geometry.morphAttributes).length>0&&Rn(T,i),T.name=s.createUniqueName(i.name||"mesh_"+e),$(T,i),x.extensions&&le(n,T,x),s.assignFinalMaterial(T),u.push(T)}for(let p=0,w=u.length;p<w;p++)s.associations.set(u[p],{meshes:e,primitives:p});if(u.length===1)return u[0];const f=new ue;s.associations.set(f,{meshes:e});for(let p=0,w=u.length;p<w;p++)f.add(u[p]);return f})}loadCamera(e){let s;const t=this.json.cameras[e],n=t[t.type];if(!n){console.warn("THREE.GLTFLoader: Missing camera parameters.");return}return t.type==="perspective"?s=new Be(Oe.radToDeg(n.yfov),n.aspectRatio||1,n.znear||1,n.zfar||2e6):t.type==="orthographic"&&(s=new He(-n.xmag,n.xmag,n.ymag,-n.ymag,n.znear,n.zfar)),t.name&&(s.name=this.createUniqueName(t.name)),$(s,t),Promise.resolve(s)}loadSkin(e){const s=this.json.skins[e],t={joints:s.joints};return s.inverseBindMatrices===void 0?Promise.resolve(t):this.getDependency("accessor",s.inverseBindMatrices).then(function(n){return t.inverseBindMatrices=n,t})}loadAnimation(e){const t=this.json.animations[e],n=[],i=[],r=[],a=[],o=[];for(let l=0,h=t.channels.length;l<h;l++){const u=t.channels[l],f=t.samplers[u.sampler],p=u.target,w=p.node,E=t.parameters!==void 0?t.parameters[f.input]:f.input,x=t.parameters!==void 0?t.parameters[f.output]:f.output;n.push(this.getDependency("node",w)),i.push(this.getDependency("accessor",E)),r.push(this.getDependency("accessor",x)),a.push(f),o.push(p)}return Promise.all([Promise.all(n),Promise.all(i),Promise.all(r),Promise.all(a),Promise.all(o)]).then(function(l){const h=l[0],u=l[1],f=l[2],p=l[3],w=l[4],E=[];for(let T=0,P=h.length;T<P;T++){const m=h[T],v=u[T],g=f[T],S=p[T],_=w[T];if(m===void 0)continue;m.updateMatrix();let R;switch(q[_.path]){case q.weights:R=ks;break;case q.rotation:R=lt;break;case q.position:case q.scale:default:R=Us;break}const M=m.name?m.name:m.uuid,C=S.interpolation!==void 0?yn[S.interpolation]:St,y=[];q[_.path]===q.weights?m.traverse(function(D){D.morphTargetInfluences&&y.push(D.name?D.name:D.uuid)}):y.push(M);let U=g.array;if(g.normalized){const D=ke(U.constructor),B=new Float32Array(U.length);for(let O=0,Q=U.length;O<Q;O++)B[O]=U[O]*D;U=B}for(let D=0,B=y.length;D<B;D++){const O=new R(y[D]+"."+q[_.path],v.array,U,C);S.interpolation==="CUBICSPLINE"&&(O.createInterpolant=function(j){const H=this instanceof lt?vn:Dt;return new H(this.times,this.values,this.getValueSize()/3,j)},O.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0),E.push(O)}}const x=t.name?t.name:"animation_"+e;return new ys(x,void 0,E)})}createNodeMesh(e){const s=this.json,t=this,n=s.nodes[e];return n.mesh===void 0?null:t.getDependency("mesh",n.mesh).then(function(i){const r=t._getNodeRef(t.meshCache,n.mesh,i);return n.weights!==void 0&&r.traverse(function(a){if(!!a.isMesh)for(let o=0,l=n.weights.length;o<l;o++)a.morphTargetInfluences[o]=n.weights[o]}),r})}loadNode(e){const s=this.json,t=this.extensions,n=this,i=s.nodes[e],r=i.name?n.createUniqueName(i.name):"";return function(){const a=[],o=n._invokeOne(function(l){return l.createNodeMesh&&l.createNodeMesh(e)});return o&&a.push(o),i.camera!==void 0&&a.push(n.getDependency("camera",i.camera).then(function(l){return n._getNodeRef(n.cameraCache,i.camera,l)})),n._invokeAll(function(l){return l.createNodeAttachment&&l.createNodeAttachment(e)}).forEach(function(l){a.push(l)}),Promise.all(a)}().then(function(a){let o;if(i.isBone===!0?o=new Es:a.length>1?o=new ue:a.length===1?o=a[0]:o=new Ss,o!==a[0])for(let l=0,h=a.length;l<h;l++)o.add(a[l]);if(i.name&&(o.userData.name=i.name,o.name=r),$(o,i),i.extensions&&le(t,o,i),i.matrix!==void 0){const l=new be;l.fromArray(i.matrix),o.applyMatrix4(l)}else i.translation!==void 0&&o.position.fromArray(i.translation),i.rotation!==void 0&&o.quaternion.fromArray(i.rotation),i.scale!==void 0&&o.scale.fromArray(i.scale);return n.associations.has(o)||n.associations.set(o,{}),n.associations.get(o).nodes=e,o})}loadScene(e){const s=this.json,t=this.extensions,n=this.json.scenes[e],i=this,r=new ue;n.name&&(r.name=i.createUniqueName(n.name)),$(r,n),n.extensions&&le(t,r,n);const a=n.nodes||[],o=[];for(let l=0,h=a.length;l<h;l++)o.push(Nt(a[l],r,s,i));return Promise.all(o).then(function(){const l=h=>{const u=new Map;for(const[f,p]of i.associations)(f instanceof Ae||f instanceof ot)&&u.set(f,p);return h.traverse(f=>{const p=i.associations.get(f);p!=null&&u.set(f,p)}),u};return i.associations=l(r),r})}}function Nt(d,e,s,t){const n=s.nodes[d];return t.getDependency("node",d).then(function(i){if(n.skin===void 0)return i;let r;return t.getDependency("skin",n.skin).then(function(a){r=a;const o=[];for(let l=0,h=r.joints.length;l<h;l++)o.push(t.getDependency("node",r.joints[l]));return Promise.all(o)}).then(function(a){return i.traverse(function(o){if(!o.isMesh)return;const l=[],h=[];for(let u=0,f=a.length;u<f;u++){const p=a[u];if(p){l.push(p);const w=new be;r.inverseBindMatrices!==void 0&&w.fromArray(r.inverseBindMatrices.array,u*16),h.push(w)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',r.joints[u])}o.bind(new Rs(l,h),o.matrixWorld)}),i})}).then(function(i){e.add(i);const r=[];if(n.children){const a=n.children;for(let o=0,l=a.length;o<l;o++){const h=a[o];r.push(Nt(h,i,s,t))}}return Promise.all(r)})}function Pn(d,e,s){const t=e.attributes,n=new De;if(t.POSITION!==void 0){const a=s.json.accessors[t.POSITION],o=a.min,l=a.max;if(o!==void 0&&l!==void 0){if(n.set(new I(o[0],o[1],o[2]),new I(l[0],l[1],l[2])),a.normalized){const h=ke(fe[a.componentType]);n.min.multiplyScalar(h),n.max.multiplyScalar(h)}}else{console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.");return}}else return;const i=e.targets;if(i!==void 0){const a=new I,o=new I;for(let l=0,h=i.length;l<h;l++){const u=i[l];if(u.POSITION!==void 0){const f=s.json.accessors[u.POSITION],p=f.min,w=f.max;if(p!==void 0&&w!==void 0){if(o.setX(Math.max(Math.abs(p[0]),Math.abs(w[0]))),o.setY(Math.max(Math.abs(p[1]),Math.abs(w[1]))),o.setZ(Math.max(Math.abs(p[2]),Math.abs(w[2]))),f.normalized){const E=ke(fe[f.componentType]);o.multiplyScalar(E)}a.max(o)}else console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}}n.expandByVector(a)}d.boundingBox=n;const r=new Gs;n.getCenter(r.center),r.radius=n.min.distanceTo(n.max)/2,d.boundingSphere=r}function gt(d,e,s){const t=e.attributes,n=[];function i(r,a){return s.getDependency("accessor",r).then(function(o){d.setAttribute(a,o)})}for(const r in t){const a=Ue[r]||r.toLowerCase();a in d.attributes||n.push(i(t[r],a))}if(e.indices!==void 0&&!d.index){const r=s.getDependency("accessor",e.indices).then(function(a){d.setIndex(a)});n.push(r)}return $(d,e),Pn(d,e,s),Promise.all(n).then(function(){return e.targets!==void 0?Sn(d,e.targets,s):d})}function xt(d,e){let s=d.getIndex();if(s===null){const r=[],a=d.getAttribute("position");if(a!==void 0){for(let o=0;o<a.count;o++)r.push(o);d.setIndex(r),s=d.getIndex()}else return console.error("THREE.GLTFLoader.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),d}const t=s.count-2,n=[];if(e===Rt)for(let r=1;r<=t;r++)n.push(s.getX(0)),n.push(s.getX(r)),n.push(s.getX(r+1));else for(let r=0;r<t;r++)r%2===0?(n.push(s.getX(r)),n.push(s.getX(r+1)),n.push(s.getX(r+2))):(n.push(s.getX(r+2)),n.push(s.getX(r+1)),n.push(s.getX(r)));n.length/3!==t&&console.error("THREE.GLTFLoader.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");const i=d.clone();return i.setIndex(n),i}class Cn extends wt{constructor(){super(),this._queue=[],this._store={},this._renderer=null}get TYPES(){return{File:"File",Image:"Image",Texture:"Texture",HDRI:"HDRI",GLTF:"GLTF"}}get LOADERS(){return{[this.TYPES.File]:new Ke,[this.TYPES.Texture]:new yt,[this.TYPES.HDRI]:new _t,[this.TYPES.GLTF]:new en}}setRenderer(e){this._renderer=e}queue(e,s,t){this._queue.push({url:e,key:s||e.split("\\").pop().split("/").pop().split(".").pop(),type:t||this.TYPES.File})}async process({url:e,key:s,type:t}){if(this.has(s))return;const n=this.LOADERS[t];switch(t){case this.TYPES.File:n.responseType="blob",await new Promise(o=>n.load(e,l=>{this._store[s]=URL.createObjectURL(l),o()}));break;case this.TYPES.Image:const i=new Image;await new Promise(o=>{i.onload=o,i.src=e}),this._store[s]=i;break;case this.TYPES.Texture:case this.TYPES.HDRI:const r=await n.loadAsync(e);this._renderer?this._renderer.initTexture(r):console.warn("AssetStore.process(): A texture is being processed but no renderer is set","call setRenderer() to allow the AssetLoader instance to decode the texture","on the GPU during the loading process and avoid first-render lags"),this._store[s]=r;break;case this.TYPES.GLTF:const a=await n.loadAsync(e);this._store[s]=a;break}return this._store[s]}async load(){await Promise.all(this._queue.map(async e=>{await this.process(e),console.debug("AssetStore.load(): "+e.key),this.dispatchEvent({type:"progress",current:Object.keys(this._store).length,total:this._queue.length})})),this.dispatchEvent({type:"loaded"}),this._queue=[]}get(e){if(this.has(e))return this._store[e];throw`AssetStore.get() : asset with key ${e} not found in loaded assets`}has(e){return e in this._store}}const G=new Cn,In=""+new URL("Loewe_C.6e7176f5.glb",import.meta.url).href,On=""+new URL("Pferdestatue_C.5177dfd7.glb",import.meta.url).href,Dn=""+new URL("Engel_C.123fd656.glb",import.meta.url).href;G.queue(In,"Loewe_C",G.TYPES.GLTF);G.queue(On,"Pferdestatue_C",G.TYPES.GLTF);G.queue(Dn,"Engel_C",G.TYPES.GLTF);G.queue(Lt,"envmap",G.TYPES.HDRI);class Nn extends me{async start(){this.renderer.outputEncoding=Z,this.camera.position.set(-20,5,0),this.controls.target.set(0,5,0);const e=new L(new pe(128,128),new ee);e.rotation.x=-Math.PI/2,this.scene.add(e),this.scene.fog=new Hs(16777215,32,64);const s=document.createElement("div");Object.assign(s.style,{position:"absolute",width:"100%",height:"100%",display:"flex",alignItems:"center",justifyContent:"center",background:"black",color:"white",fontFamily:"monospace",fontSize:"xx-large",textAlign:"center",transition:"opacity 500ms ease",pointerEvents:"none"});const t=document.createElement("p");s.append(t),document.body.prepend(s),G.addEventListener("progress",({current:o,total:l})=>{const h=(o/l*100).toFixed(0).padStart(3,"0");t.innerHTML=`${h}<br>(${o}/${l})`}),G.addEventListener("loaded",async()=>{await new Promise(o=>setTimeout(o,500)),s.style.opacity=0}),await G.load();const n=G.get("envmap");new At(this.renderer,this.scene,{texture:n,equirectangular:!0,background:!1});const i=G.get("Loewe_C");this.scene.add(i.scene);const r=G.get("Pferdestatue_C");r.scene.position.set(0,0,8),this.scene.add(r.scene);const a=G.get("Engel_C");a.scene.position.set(0,0,-8),this.scene.add(a.scene)}}const Ft={BlurredReflectorExample:qs,ContactShadowsExample:Ys,EnvironmentExample:zs,ProgressiveShadowsExample:Js,AssetLoaderExample:Nn},Fn=window.location.hash.replace("#",""),Ge={example:Fn},Ut=new Tweakpane.Pane,Un=Ut.addInput(Ge,"example",{label:"Example",options:Object.keys(Ft).reduce((d,e)=>(d[e]=e,d),{})});Un.on("change",d=>{window.location.hash=d.value,window.location.reload()});if(Ge.example){const d=Ut.addFolder({title:"Parameters"});new Ft[Ge.example]({gui:d})}
